
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketSafe Admin Panel - Product Management & Moderation</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="MarketSafe Admin Panel - Manage products, moderate listings, review user submissions, and oversee marketplace operations. Secure admin dashboard for MarketSafe marketplace platform. Global marketplace administration tool.">
    <meta name="keywords" content="MarketSafe, admin panel, product management, marketplace admin, product moderation, admin dashboard, e-commerce admin, marketplace management, online marketplace, product administration, content moderation, seller management, global marketplace, business admin, marketplace platform">
    <meta name="author" content="MarketSafe">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="language" content="English">
    <meta name="revisit-after" content="1 days">
    <meta name="rating" content="general">
    <meta name="distribution" content="global">
    <meta name="geo.region" content="US">
    <meta name="geo.placename" content="Global">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="MarketSafe Admin Panel - Product Management & Moderation">
    <meta property="og:description" content="Manage products, moderate listings, and oversee marketplace operations with MarketSafe Admin Panel. Global marketplace administration dashboard.">
    <meta property="og:url" content="https://marketsafe-e57cf.web.app/admin.html">
    <meta property="og:site_name" content="MarketSafe Admin">
    <meta property="og:locale" content="en_US">
    <meta property="og:locale:alternate" content="en_GB">
    <meta property="og:locale:alternate" content="es_ES">
    <meta property="og:locale:alternate" content="fr_FR">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="MarketSafe Admin Panel">
    <meta name="twitter:description" content="Manage products, moderate listings, and oversee marketplace operations globally">
    <meta name="twitter:site" content="@marketsafe">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://marketsafe-e57cf.web.app/admin.html">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="logo.png"/>
    <link rel="apple-touch-icon" href="logo.png">
    
    <!-- Hreflang for International SEO -->
    <link rel="alternate" hreflang="en" href="https://marketsafe-e57cf.web.app/admin.html">
    <link rel="alternate" hreflang="x-default" href="https://marketsafe-e57cf.web.app/admin.html">
    
    <!-- Structured Data (JSON-LD) for Better Search Visibility -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "MarketSafe Admin Panel",
      "description": "Admin dashboard for managing products, moderating listings, and overseeing marketplace operations",
      "url": "https://marketsafe-e57cf.web.app/admin.html",
      "applicationCategory": "BusinessApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "5",
        "ratingCount": "1"
      }
    }
    </script>
    
    <!-- 
    NOTE: For profile photos to display properly, open this file through a web server:
    - Option 1: Use http://localhost:8000/admin.html (recommended)
    - Option 2: Use file:// protocol but profile photos may not display due to CORS restrictions
    -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-red: #dc3545;
            --dark-red: #b02a37;
            --light-red: #f8d7da;
            --pure-white: #ffffff;
            --pure-black: #000000;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --medium-gray: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--pure-black) 50%, var(--dark-red) 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--pure-white);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        

        /* Header/Navbar */
        .navbar {
            background-color: var(--pure-black) !important;
            border-bottom: 3px solid var(--primary-red);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            padding: 1rem 0;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            font-weight: 700;
            color: var(--pure-white) !important;
            text-decoration: none;
        }

        .navbar-brand img {
            height: 40px;
            width: auto;
            margin-right: 15px;
        }

        .logo-img {
            height: 40px;
            width: auto;
            margin-right: 15px;
            border-radius: 5px;
        }

        .navbar-brand .brand-text {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: var(--pure-white);
        }

        .navbar-text {
            color: var(--pure-white) !important;
        }

        /* Main Content */
        .main-content {
            background: transparent;
            min-height: calc(100vh - 80px);
            padding: 2rem 0;
        }

        /* Container styling for gradient background */
        .container {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Stats Cards */
        .stats-card {
            background-color: var(--pure-black) !important;
            border: 2px solid var(--pure-white) !important;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .stats-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--pure-white) !important;
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .stats-label {
            font-size: 1rem;
            color: var(--pure-white) !important;
            margin-top: 0.5rem;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .stats-icon {
            font-size: 2.5rem;
            color: var(--pure-white);
            margin-bottom: 1rem;
        }

        /* Ensure all text inside stats cards is white */
        .stats-card,
        .stats-card *,
        .stats-card .card-body,
        .stats-card .card-body *,
        .card.stats-card,
        .card.stats-card *,
        .card.stats-card .card-body,
        .card.stats-card .card-body * {
            color: var(--pure-white) !important;
        }

        .stats-card .text-white,
        .card.stats-card .text-white {
            color: var(--pure-white) !important;
        }

        /* Override Bootstrap card text color */
        .card.stats-card.text-white {
            color: var(--pure-white) !important;
            background-color: var(--pure-black) !important;
        }

        .card.stats-card.text-white * {
            color: var(--pure-white) !important;
        }

        /* Override Bootstrap card background */
        .card.stats-card {
            background-color: var(--pure-black) !important;
            border: 2px solid var(--pure-white) !important;
        }

        .card.stats-card .card-body {
            background-color: var(--pure-black) !important;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-red), var(--dark-red));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--pure-white);
            font-weight: 700;
            font-size: 1.1rem;
            border: 2px solid var(--primary-red);
        }

        .profile-pic-container {
            width: 45px;
            height: 45px;
            position: relative;
        }

        .profile-pic-small {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-red);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
            display: block;
            background-color: var(--light-gray);
        }

        .profile-pic-small:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .verification-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 600;
        }

        .verification-badge.completed {
            background-color: var(--light-red);
            color: var(--primary-red);
            border: 1px solid var(--primary-red);
        }

        .verification-badge.pending {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            border: 1px solid var(--medium-gray);
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .status-pending {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            border: 1px solid var(--medium-gray);
        }

        .status-verified {
            background-color: var(--primary-red);
            color: var(--pure-white);
            border: 1px solid var(--primary-red);
        }

        .status-rejected {
            background-color: var(--pure-black);
            color: var(--pure-white);
            border: 1px solid var(--pure-black);
        }

        .connection-status {
            border-radius: 10px;
            border-left: 4px solid;
        }

        .connection-status.success {
            border-left-color: var(--primary-red);
            background-color: var(--light-red);
        }

        .connection-status.error {
            border-left-color: var(--pure-black);
            background-color: var(--light-gray);
        }

        .connection-status.info {
            border-left-color: var(--medium-gray);
            background-color: var(--light-gray);
        }

        .table {
            background-color: var(--pure-white);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid var(--pure-black);
        }

        .table thead th {
            background-color: var(--pure-black);
            color: var(--pure-white);
            border: none;
            font-weight: 700;
            padding: 1rem 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
            border-top: 1px solid var(--light-gray);
            color: var(--pure-black);
            background-color: var(--pure-white);
        }

        .table tbody tr:hover {
            background-color: var(--light-red);
        }

        .table tbody tr:nth-child(even) {
            background-color: var(--light-gray);
        }

        .table tbody tr:nth-child(even):hover {
            background-color: var(--light-red);
        }

        /* Tab Styling */
        .nav-tabs {
            border-bottom: 2px solid var(--primary-red);
            margin-bottom: 0;
        }

        .nav-tabs .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--medium-gray);
            font-weight: 600;
            padding: 1rem 1.5rem;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
            background-color: transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-red);
            background-color: transparent;
            border-color: var(--primary-red);
            border-bottom-color: var(--primary-red);
        }

        .tab-content {
            background-color: transparent;
            border: none;
            padding: 0;
        }

        /* Connection Status Styling */
        .connection-status {
            margin-bottom: 1rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .connection-status.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .connection-status.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .connection-status.info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .btn {
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-red);
            border-color: var(--primary-red);
            color: var(--pure-white);
        }

        .btn-primary:hover {
            background-color: var(--dark-red);
            border-color: var(--dark-red);
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--primary-red);
            border-color: var(--primary-red);
            color: var(--pure-white);
        }

        .btn-success:hover {
            background-color: var(--dark-red);
            border-color: var(--dark-red);
        }

        .btn-danger {
            background-color: var(--pure-black);
            border-color: var(--pure-black);
            color: var(--pure-white);
        }

        .btn-danger:hover {
            background-color: var(--dark-gray);
            border-color: var(--dark-gray);
        }

        .btn-outline-secondary {
            color: var(--dark-gray);
            border-color: var(--medium-gray);
        }

        .btn-outline-secondary:hover {
            background-color: var(--dark-gray);
            border-color: var(--dark-gray);
            color: var(--pure-white);
        }

        /* Additional styling */
        .card {
            border: 2px solid var(--pure-black);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            background-color: var(--pure-white);
        }

        .card-header {
            background-color: var(--pure-black);
            color: var(--pure-white);
            border-bottom: none;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loading-spinner {
            color: var(--primary-red);
        }

        .alert {
            border-radius: 10px;
            border: 2px solid;
        }

        .alert-success {
            background-color: var(--light-red);
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        .alert-danger {
            background-color: var(--light-gray);
            border-color: var(--pure-black);
            color: var(--pure-black);
        }

        .alert-info {
            background-color: var(--light-gray);
            border-color: var(--medium-gray);
            color: var(--dark-gray);
        }

        .modal-content {
            border: 2px solid var(--pure-black);
            border-radius: 15px;
            background-color: var(--pure-white) !important;
            color: var(--pure-black) !important;
        }
        
        #loginModal {
            z-index: 1055 !important;
        }
        
        #loginModal .modal-dialog {
            z-index: 1056 !important;
        }
        
        #loginModal .modal-content {
            z-index: 1057 !important;
        }

        .modal-header {
            background-color: var(--pure-black);
            color: var(--pure-white);
            border-bottom: none;
        }
        
        /* User modal text styling */
        .modal-body h6 {
            color: var(--primary-red) !important;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-red);
            padding-bottom: 0.5rem;
        }
        
        .modal-body .mb-3 {
            color: var(--pure-black) !important;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .modal-body strong {
            color: var(--pure-black) !important;
            font-weight: 600;
        }
        
        .modal-body code {
            background: var(--light-gray);
            color: var(--primary-red) !important;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .modal-footer {
            border-top: 1px solid var(--light-gray);
        }

        .face-image {
            max-width: 100%;
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--primary-red);
        }
        
        .face-image-container {
            text-align: center;
            background: var(--light-gray);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid var(--medium-gray);
        }
        
        .face-image-label {
            font-size: 0.8rem;
            color: var(--primary-red);
            font-weight: 600;
            margin-top: 5px;
            text-align: center;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--secondary-color);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="logo.png" alt="MarketSafe Logo" class="logo-img">
                <span class="brand-text">MARKETSAFE</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content" style="display: none;">
        <div class="container-fluid">
            <!-- Connection Status -->
            <div id="connectionStatus" class="alert connection-status" style="display: none;"></div>

        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-3">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </h2>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stats-number" id="totalUsers">0</div>
                                <div class="stats-label">Total Users</div>
                            </div>
                            <div>
                                <i class="fas fa-users fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stats-number" id="pendingUsers">0</div>
                                <div class="stats-label">Pending Verification</div>
                            </div>
                            <div>
                                <i class="fas fa-clock fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stats-number" id="verifiedUsers">0</div>
                                <div class="stats-label">Verified Users</div>
                            </div>
                            <div>
                                <i class="fas fa-check-circle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stats-number" id="rejectedUsers">0</div>
                                <div class="stats-label">Rejected Users</div>
                            </div>
                            <div>
                                <i class="fas fa-times-circle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- APK Download Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-download me-2"></i>Download MarketSafe App
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-2">
                                    <i class="fas fa-mobile-alt me-2 text-primary"></i>Android APK
                                </h6>
                                <p class="text-muted mb-2">
                                    Download the latest version of MarketSafe mobile app for Android devices.
                                </p>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Version: 1.0.4 | Build: Latest | Size: ~95 MB
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <button onclick="downloadAPK(event)" 
                                        class="btn btn-primary btn-lg"
                                        id="apkDownloadLink">
                                    <i class="fas fa-download me-2"></i>Download APK
                                </button>
                            </div>
                        </div>
                        <hr>
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Installation Instructions:</strong>
                            <ol class="mb-0 mt-2">
                                <li>Download the APK file to your Android device</li>
                                <li>Enable "Install from Unknown Sources" in your device settings</li>
                                <li>Open the downloaded APK file and follow the installation prompts</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="row mb-4">
            <div class="col-12">
                <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="true">
                            <i class="fas fa-users me-2"></i>User Management
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab" aria-controls="products" aria-selected="false">
                            <i class="fas fa-shopping-cart me-2"></i>Product Moderation
                        </button>
                    </li>
                    <li class="nav-item" role="presentation" id="adminManagementTabItem" style="display: none;">
                        <button class="nav-link" id="adminManagement-tab" data-bs-toggle="tab" data-bs-target="#adminManagement" type="button" role="tab" aria-controls="adminManagement" aria-selected="false">
                            <i class="fas fa-user-shield me-2"></i>Admin Management
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">
                            <i class="fas fa-flag me-2"></i>User Reports
                            <span class="badge bg-danger ms-2" id="pendingReportsBadge" style="display: none;">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="messaging-tab" data-bs-toggle="tab" data-bs-target="#messaging" type="button" role="tab" aria-controls="messaging" aria-selected="false">
                            <i class="fas fa-bullhorn me-2"></i>Message All Users
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="adminTabsContent">
            <!-- User Management Tab -->
            <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
                <!-- User Management -->
                <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2"></i>User Management
                                </h5>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="searchInput" placeholder="Search users...">
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="statusFilter">
                                            <option value="">All Status</option>
                                            <option value="pending">Pending</option>
                                            <option value="verified">Verified</option>
                                            <option value="rejected">Rejected</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-primary w-100" onclick="loadUsers()">
                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Contact</th>
                                        <th>Status</th>
                                        <th>Face Verification</th>
                                        <th>Registered</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <span class="ms-2">Loading users...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>

            <!-- Admin Management Tab -->
            <div class="tab-pane fade" id="adminManagement" role="tabpanel" aria-labelledby="adminManagement-tab">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-user-shield me-2"></i>Admin Accounts
                                    </h5>
                                    <button class="btn btn-primary" onclick="showCreateAdminModal()">
                                        <i class="fas fa-plus me-2"></i>Add New Admin
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="adminsList" class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Role</th>
                                                <th>Last Login</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminsTableBody">
                                            <tr>
                                                <td colspan="5" class="text-center">Loading admins...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-flag me-2"></i>User Reports
                                    </h5>
                                    <div>
                                        <select class="form-select d-inline-block" id="reportStatusFilter" style="width: auto;" onchange="loadReports()">
                                            <option value="">All Reports</option>
                                            <option value="pending">Pending</option>
                                            <option value="reviewed">Reviewed</option>
                                            <option value="resolved">Resolved</option>
                                            <option value="dismissed">Dismissed</option>
                                        </select>
                                        <button class="btn btn-outline-primary ms-2" onclick="loadReports()">
                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Reported User</th>
                                                <th>Reporter</th>
                                                <th>Reason</th>
                                                <th>Details</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="reportsTableBody">
                                            <tr>
                                                <td colspan="7" class="text-center">
                                                    <div class="loading-spinner">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <span class="ms-2">Loading reports...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Messaging Tab -->
            <div class="tab-pane fade" id="messaging" role="tabpanel" aria-labelledby="messaging-tab">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-bullhorn me-2"></i>Send Message to All Users
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Note:</strong> This message will be sent as a notification to all users in the app. Use this for important warnings, announcements, or updates.
                                </div>
                                <form id="adminMessageForm" onsubmit="sendAdminMessage(event)">
                                    <div class="mb-3">
                                        <label for="messageType" class="form-label">Message Type</label>
                                        <select class="form-select" id="messageType" required>
                                            <option value="warning">‚ö†Ô∏è Warning</option>
                                            <option value="announcement">üì¢ Announcement</option>
                                            <option value="info">‚ÑπÔ∏è Information</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="adminMessage" class="form-label">Message</label>
                                        <textarea class="form-control" id="adminMessage" rows="5" required placeholder="Enter your message here..."></textarea>
                                        <small class="form-text text-muted">This message will be sent to all users as a notification.</small>
                                    </div>
                                    <div class="mb-3">
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Warning:</strong> This action will send a notification to <span id="totalUsersCount">...</span> users. Please review your message before sending.
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary" id="sendMessageBtn">
                                        <i class="fas fa-paper-plane me-2"></i>Send Message to All Users
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Moderation Tab -->
            <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
                <!-- Product Moderation Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-lg">
                    <div class="card-header bg-dark text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>Product Moderation
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Product Stats -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h3 id="pendingProducts">0</h3>
                                        <p class="mb-0">Pending Review</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3 id="approvedProducts">0</h3>
                                        <p class="mb-0">Approved</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h3 id="rejectedProducts">0</h3>
                                        <p class="mb-0">Rejected</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h3 id="totalProducts">0</h3>
                                        <p class="mb-0">Total Products</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Product Filters -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <input type="text" id="productSearchInput" class="form-control" placeholder="Search products...">
                            </div>
                            <div class="col-md-3">
                                <select id="productStatusFilter" class="form-select">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select id="productCategoryFilter" class="form-select">
                                    <option value="">All Categories</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Furniture">Furniture</option>
                                    <option value="Menswear">Menswear</option>
                                    <option value="Womenswear">Womenswear</option>
                                    <option value="Accessories">Accessories</option>
                                    <option value="Vehicle">Vehicle</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" onclick="loadProducts()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Seller</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading products...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user me-2"></i>User Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="userModalBody">
                    <!-- User details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="approveBtn" onclick="updateUserStatus('verified')" style="display: none;">
                        <i class="fas fa-check me-1"></i>Approve
                    </button>
                    <button type="button" class="btn btn-danger" id="rejectBtn" onclick="updateUserStatus('rejected')" style="display: none;">
                        <i class="fas fa-times me-1"></i>Reject
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteUserBtn" onclick="deleteUser()" style="display: none;">
                        <i class="fas fa-trash me-1"></i>Delete User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Face Image Preview Modal -->
    <div class="modal fade" id="faceImageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-image me-2"></i>Face Verification Image
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="faceImagePreview" src="" alt="Face Image" class="img-fluid" style="max-height: 500px; border-radius: 10px;">
                    <div id="faceImageTitle" class="mt-3 text-muted"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-shopping-cart me-2"></i>Product Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="productImages" class="mb-3">
                                <!-- Product images will be loaded here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4 id="productTitle">Product Title</h4>
                            <p class="text-muted" id="productDescription">Product description</p>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Price:</strong> $<span id="productPrice">0</span>
                                </div>
                                <div class="col-6">
                                    <strong>Condition:</strong> <span id="productCondition">New</span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Category:</strong> <span id="productCategory">Electronics</span>
                                </div>
                                <div class="col-6">
                                    <strong>Status:</strong> <span id="productStatus" class="badge">Pending</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <strong>Seller:</strong> <span id="productSeller">Unknown</span>
                            </div>
                            <div class="mb-3">
                                <strong>Created:</strong> <span id="productCreated">Unknown</span>
                            </div>
                            <div id="rejectionReasonDiv" class="mb-3" style="display: none;">
                                <strong>Rejection Reason:</strong> <span id="productRejectionReason">None</span>
                            </div>
                            <div class="mb-3">
                                <hr>
                                <h6><i class="fas fa-info-circle me-2"></i>Image Metadata</h6>
                                <div id="imageMetadata" class="small" style="max-height: 200px; overflow-y: auto; color: #333;">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2" style="color: #333;">Loading metadata...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div id="productActions">
                        <button type="button" class="btn btn-success" id="approveProductBtn" onclick="approveProduct()">
                            <i class="fas fa-check me-1"></i>Approve
                        </button>
                        <button type="button" class="btn btn-warning" id="rejectProductBtn" onclick="showRejectModal()">
                            <i class="fas fa-times me-1"></i>Reject
                        </button>
                        <button type="button" class="btn btn-danger" id="deleteProductBtn" onclick="showDeleteModal()">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Media Preview Modal -->
    <div class="modal fade" id="mediaPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="background: #1a1a1a; color: white; border: none;">
                <div class="modal-header" style="background: #2b2b2b; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 1rem 1.5rem;">
                    <h5 class="modal-title mb-0" style="font-weight: 600; letter-spacing: 0.5px;">
                        <i class="fas fa-images me-2"></i>Product Media Preview
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="opacity: 0.8;"></button>
                </div>
                <div class="modal-body p-0" style="background: #000;">
                    <div id="mediaPreviewCarousel" class="carousel slide">
                        <div class="carousel-inner" id="mediaPreviewCarouselInner" style="min-height: 500px; background: #000;">
                            <!-- Media items will be loaded here -->
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#mediaPreviewCarousel" data-bs-slide="prev" style="width: 60px; opacity: 0.8;">
                            <span class="carousel-control-prev-icon" aria-hidden="true" style="background-color: rgba(0,0,0,0.5); border-radius: 50%; width: 50px; height: 50px;"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#mediaPreviewCarousel" data-bs-slide="next" style="width: 60px; opacity: 0.8;">
                            <span class="carousel-control-next-icon" aria-hidden="true" style="background-color: rgba(0,0,0,0.5); border-radius: 50%; width: 50px; height: 50px;"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                    <div class="text-center py-3" style="background: #2b2b2b; border-top: 1px solid rgba(255,255,255,0.1);">
                        <span class="badge bg-dark px-3 py-2" id="mediaPreviewCounter" style="font-size: 0.9rem; font-weight: 500; letter-spacing: 0.5px;">1 / 1</span>
                    </div>
                </div>
                <div class="modal-footer" style="background: #2b2b2b; border-top: 1px solid rgba(255,255,255,0.1); padding: 1rem 1.5rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="min-width: 100px;">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Product Modal -->
    <div class="modal fade" id="deleteProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #1a1a1a; color: white; border: 1px solid rgba(220, 53, 69, 0.3);">
                <div class="modal-header" style="background: #2b2b2b; border-bottom: 1px solid rgba(220, 53, 69, 0.3);">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>Delete Product
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Are you sure you want to delete this product? This action cannot be undone.</p>
                    <div class="alert alert-danger mb-0" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Warning:</strong> This will permanently delete:
                        <ul class="mb-0 mt-2">
                            <li>The product from the database</li>
                            <li>All product images/videos</li>
                            <li>All associated comments</li>
                            <li>All product data</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer" style="background: #2b2b2b; border-top: 1px solid rgba(220, 53, 69, 0.3);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteProduct()">
                        <i class="fas fa-trash me-1"></i>Delete Permanently
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Product Modal -->
    <div class="modal fade" id="rejectProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reject Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="rejectionReason" class="form-label">Rejection Reason</label>
                        <select id="rejectionReason" class="form-select">
                            <option value="">Select a reason...</option>
                            <option value="Inappropriate content">Inappropriate content</option>
                            <option value="Poor quality images">Poor quality images</option>
                            <option value="Misleading description">Misleading description</option>
                            <option value="Prohibited item">Prohibited item</option>
                            <option value="Duplicate listing">Duplicate listing</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="customRejectionReason" class="form-label">Custom Reason (if Other selected)</label>
                        <textarea id="customRejectionReason" class="form-control" rows="3" placeholder="Enter custom rejection reason..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="confirmRejectProduct()">
                        <i class="fas fa-times me-1"></i>Reject Product
                    </button>
                    <button type="button" class="btn btn-warning" onclick="testNotification()">
                        <i class="fas fa-bell me-1"></i>Test Notification
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: 'AIzaSyAa-268Fx-XfJTsJLGznwcztd82r2vdf3Q',
            authDomain: 'marketsafe-e57cf.firebaseapp.com',
            projectId: 'marketsafe-e57cf'
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        window.firebaseAuth = auth;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

<script>
    // Firebase REST API configuration
    const FIREBASE_CONFIG = {
        projectId: 'marketsafe-e57cf',
        databaseId: 'marketsafe', // Your specific database
        apiKey: 'AIzaSyAa-268Fx-XfJTsJLGznwcztd82r2vdf3Q'
    };

    // Firebase REST API endpoints
    const FIREBASE_REST_BASE = `https://firestore.googleapis.com/v1/projects/${FIREBASE_CONFIG.projectId}/databases/${FIREBASE_CONFIG.databaseId}/documents`;
    
    // Backend API URL for Luxand operations
    const BACKEND_API_URL = 'https://marketsafe-production.up.railway.app';

    // Global variables
    let usersData = {};
    let selectedUserId = null;
    let currentUser = null;
    let currentUserRole = null;
    let currentUserPermissions = null;
    let isCreatingAdmin = false; // Flag to prevent auth state change during admin creation
    
    // Real-time functionality variables
    let socket = null;
    let isConnected = false;
    let autoRefreshInterval = null;
    let lastUpdateTime = null;
    let realTimeNotifications = true;

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
        console.log('MarketSafe Admin Panel loaded with Firebase REST API');
        
        // Check authentication first - redirect to login if not authenticated
        checkAuthentication();
    });
    

    // Authentication Functions
    async function checkAuthentication() {
        console.log('üîê Checking authentication...');
        
        // Wait for Firebase Auth to load (with timeout)
        let authLoaded = false;
        await new Promise((resolve) => {
            const checkAuth = setInterval(() => {
                if (window.firebaseAuth) {
                    clearInterval(checkAuth);
                    authLoaded = true;
                    console.log('‚úÖ Firebase Auth loaded');
                    resolve();
                }
            }, 100);
            
            // Timeout after 5 seconds - redirect to login
            setTimeout(() => {
                if (!authLoaded) {
                    clearInterval(checkAuth);
                    console.warn('‚ö†Ô∏è Firebase Auth taking too long, redirecting to login');
                    window.location.replace('login.html');
                    resolve();
                }
            }, 5000);
        });

        if (!window.firebaseAuth) {
            console.error('‚ùå Firebase Auth not available, redirecting to login');
            window.location.replace('login.html');
            return;
        }

        // Check current user first (before waiting for onAuthStateChanged)
        const currentUser = window.firebaseAuth.currentUser;
        console.log('üë§ Current user (immediate check):', currentUser ? currentUser.uid : 'none');
        
        if (currentUser) {
            // User is already signed in, check admin role immediately
            console.log('‚úÖ User already signed in, checking admin role...');
            await checkAdminRole(currentUser.uid);
        } else {
            // No user signed in, set up listener for auth state changes
            console.log('‚è≥ No user signed in, waiting for auth state...');
            window.firebaseAuth.onAuthStateChanged(async (user) => {
                // Skip auth state check if we're in the middle of creating an admin
                if (isCreatingAdmin) {
                    console.log('‚è≠Ô∏è Skipping auth state check - admin creation in progress');
                    return;
                }
                
                console.log('üîÑ Auth state changed, user:', user ? user.uid : 'none');
                if (user) {
                    // User is signed in, check admin role
                    await checkAdminRole(user.uid);
                } else {
                    // User is not signed in, redirect to login page
                    console.log('‚ùå No user signed in, redirecting to login page');
                    window.location.replace('login.html');
                }
            });
        }
    }

    async function checkAdminRole(userId) {
        try {
            console.log('üîç Checking admin role for user:', userId);
            console.log('üîç Checking URL:', `${FIREBASE_REST_BASE}/adminUsers/${userId}?key=${FIREBASE_CONFIG.apiKey}`);
            
            const response = await fetch(`${FIREBASE_REST_BASE}/adminUsers/${userId}?key=${FIREBASE_CONFIG.apiKey}`);
            console.log('üìä Admin role check response status:', response.status);
            console.log('üìä Response OK:', response.ok);
            
            if (response.ok) {
                const data = await response.json();
                console.log('üìã Admin data received:', data);
                const adminData = data.fields;
                
                console.log('‚úÖ User is admin/manager');
                console.log('üìã Raw adminData from Firestore:', adminData);
                console.log('üìã Role from Firestore:', adminData.role?.stringValue);
                
                currentUser = {
                    uid: userId,
                    email: adminData.email?.stringValue || '',
                    name: adminData.name?.stringValue || '',
                    role: adminData.role?.stringValue || 'admin'
                };
                currentUserRole = currentUser.role;
                
                console.log('üë§ Set currentUserRole to:', currentUserRole);
                console.log('üë§ Current user object:', currentUser);
                currentUserPermissions = {
                    canApproveUsers: adminData.permissions?.mapValue?.fields?.canApproveUsers?.booleanValue || false,
                    canRejectUsers: adminData.permissions?.mapValue?.fields?.canRejectUsers?.booleanValue || false,
                    canViewUserData: adminData.permissions?.mapValue?.fields?.canViewUserData?.booleanValue || false,
                    canDeleteUsers: adminData.permissions?.mapValue?.fields?.canDeleteUsers?.booleanValue || false,
                    canCreateAdmins: adminData.permissions?.mapValue?.fields?.canCreateAdmins?.booleanValue || false
                };

                console.log('üë§ Current user role:', currentUserRole);
                console.log('üë§ Current user name:', currentUser.name);
                console.log('üë§ Current user email:', currentUser.email);
                console.log('üîë Permissions:', currentUserPermissions);

                // Show admin panel first
                document.querySelector('.main-content').style.display = 'block';
                document.querySelector('.navbar').style.display = 'flex';
                
                // Update navbar with user info (before updateLastLogin to show name immediately)
                updateNavbarWithUser();
                
                // Initialize admin panel (this will show Admin Management tab if manager)
                initializeAdminPanel();
                
                // Update last login (non-blocking, won't affect UI)
                updateLastLogin(userId).catch(err => {
                    console.warn('‚ö†Ô∏è Last login update failed (non-critical):', err);
                });
            } else {
                // User is not an admin - get error details
                const errorText = await response.text();
                console.error('‚ùå Admin check failed:', {
                    status: response.status,
                    statusText: response.statusText,
                    errorText: errorText,
                    userId: userId,
                    url: `${FIREBASE_REST_BASE}/adminUsers/${userId}?key=${FIREBASE_CONFIG.apiKey}`
                });
                
                // Check if it's a 404 (document not found) vs other error
                if (response.status === 404) {
                    console.error('‚ùå Manager/Admin document not found in Firestore for user ID:', userId);
                    console.error('üí° Make sure the document ID in adminUsers collection matches the Firebase Auth user ID');
                    alert(`Access Denied: Your account (${userId}) is not found in the admin database. Please contact the administrator.`);
                } else {
                    console.error('‚ùå Unexpected error checking admin role');
                    alert(`Access Denied: Error checking authorization (${response.status}). Please contact the administrator.`);
                }
                
                await window.firebaseAuth.signOut();
                window.location.replace('login.html');
            }
        } catch (error) {
            console.error('‚ùå Error checking admin role:', error);
            console.error('‚ùå Error details:', {
                message: error.message,
                stack: error.stack,
                userId: userId
            });
            await window.firebaseAuth.signOut();
            alert(`Error checking authorization: ${error.message}. Please try again.`);
            window.location.replace('login.html');
        }
    }


    function updateNavbarWithUser() {
        const navbar = document.querySelector('.navbar .container-fluid');
        if (currentUser && navbar) {
            // Remove existing user info if any
            const existingInfo = navbar.querySelector('.navbar-text');
            if (existingInfo) existingInfo.remove();
            
            // Get display name - use email if name is missing
            const displayName = currentUser.name && currentUser.name.trim() !== '' 
                ? currentUser.name 
                : (currentUser.email || 'Manager');
            
            const userInfo = document.createElement('div');
            userInfo.className = 'navbar-text ms-auto d-flex align-items-center';
            userInfo.innerHTML = `
                <span class="me-3">
                    <i class="fas fa-user me-2"></i>${escapeHtml(displayName)} (${currentUserRole || 'admin'})
                </span>
                <button class="btn btn-sm btn-outline-light" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
            `;
            navbar.appendChild(userInfo);
            
            console.log('‚úÖ Navbar updated with user:', displayName, currentUserRole);
        } else {
            console.warn('‚ö†Ô∏è Cannot update navbar - currentUser or navbar not found');
            console.log('currentUser:', currentUser);
            console.log('navbar element:', navbar);
        }
    }

    async function updateLastLogin(userId) {
        try {
            console.log('üïê Updating last login for user:', userId);
            
            // First, get the current document to preserve all existing fields
            const getResponse = await fetch(`${FIREBASE_REST_BASE}/adminUsers/${userId}?key=${FIREBASE_CONFIG.apiKey}`);
            
            if (!getResponse.ok) {
                console.warn('‚ö†Ô∏è Could not get current admin data to preserve fields');
                // Skip update if we can't get current data (to avoid overwriting)
                return;
            }
            
            const currentDoc = await getResponse.json();
            const currentFields = currentDoc.fields || {};
            
            // Merge existing fields with the new lastLoginAt field
            const updateData = {
                fields: {
                    ...currentFields, // Preserve all existing fields
                    lastLoginAt: { timestampValue: new Date().toISOString() }
                }
            };
            
            console.log('üïê Updating with preserved fields:', Object.keys(updateData.fields));
            
            const response = await fetch(`${FIREBASE_REST_BASE}/adminUsers/${userId}?key=${FIREBASE_CONFIG.apiKey}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });
            
            if (response.ok) {
                console.log('‚úÖ Last login updated successfully (all fields preserved)');
            } else {
                const errorText = await response.text();
                console.warn('‚ö†Ô∏è Failed to update last login (non-critical):', response.status, errorText);
                // Don't throw error - this is not critical for login
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Error updating last login (non-critical):', error);
            // Don't throw error - this is not critical for login
        }
    }


    async function logout() {
        try {
            console.log('üö™ Logging out...');
            await window.firebaseAuth.signOut();
            currentUser = null;
            currentUserRole = null;
            // Redirect to login page
            window.location.replace('login.html');
        } catch (error) {
            console.error('‚ùå Logout error:', error);
            // Redirect anyway
            window.location.replace('login.html');
        }
    }

    function initializeAdminPanel() {
        // Set default values for stats cards
        updateDashboardStats({});
        
        // Load users from database
        loadUsers();
        
        setupEventListeners();
        
        // Initialize real-time functionality
        initializeRealTimeFeatures();
        
        // Start auto-refresh
        startAutoRefresh();

        // Add Admin Management tab ONLY if user is manager (not regular admins)
        console.log('üîç Checking role for Admin Management tab. currentUserRole:', currentUserRole);
        console.log('üîç Type of currentUserRole:', typeof currentUserRole);
        console.log('üîç Comparison result:', currentUserRole === 'manager');
        
        if (currentUserRole === 'manager') {
            console.log('‚úÖ User is manager - showing Admin Management tab');
            addAdminManagementTab();
        } else {
            console.log('‚ùå User is not manager (role:', currentUserRole, ') - hiding Admin Management tab');
            // Hide Admin Management tab for regular admins
            const tabItem = document.getElementById('adminManagementTabItem');
            if (tabItem) {
                tabItem.style.display = 'none';
            }
        }
    }

    // Setup event listeners
    function setupEventListeners() {
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            filterUsers(e.target.value);
        });

        // Status filter
        document.getElementById('statusFilter').addEventListener('change', function(e) {
            filterUsersByStatus(e.target.value);
        });

        // Product search functionality
        document.getElementById('productSearchInput').addEventListener('input', function(e) {
            filterProducts(e.target.value);
        });

        // Product status filter
        document.getElementById('productStatusFilter').addEventListener('change', function(e) {
            filterProductsByStatus(e.target.value);
        });

        // Product category filter
        document.getElementById('productCategoryFilter').addEventListener('change', function(e) {
            filterProductsByCategory(e.target.value);
        });

        // Tab switching event listeners
        document.getElementById('users-tab').addEventListener('shown.bs.tab', function (e) {
            console.log('Switched to Users tab');
            // Users data is already loaded on page load
        });

        document.getElementById('products-tab').addEventListener('shown.bs.tab', function (e) {
            console.log('Switched to Products tab');
            // Load products when switching to products tab
            loadProducts();
        });
    }

    // ==================== REAL-TIME FUNCTIONALITY ====================
    
    // Initialize real-time features
    function initializeRealTimeFeatures() {
        console.log('Initializing real-time features...');
        
        // Initialize WebSocket connection (if available)
        initializeWebSocket();
        
        // Add real-time status indicator
        addRealTimeStatusIndicator();
        
        // Add notification settings
        addNotificationSettings();
    }
    
    // Initialize WebSocket connection
    function initializeWebSocket() {
        try {
            // Try to connect to WebSocket server (if available)
            // This would typically connect to your backend WebSocket server
            console.log('WebSocket connection not implemented yet - using polling instead');
            
            // For now, we'll use polling for real-time updates
            updateConnectionStatus('Real-time updates enabled (polling mode)', 'success');
        } catch (error) {
            console.log('WebSocket not available, using polling mode');
            updateConnectionStatus('Real-time updates enabled (polling mode)', 'info');
        }
    }
    
    // Add real-time status indicator to the UI
    function addRealTimeStatusIndicator() {
        const statusContainer = document.querySelector('.main-content .container-fluid');
        if (statusContainer) {
            const realTimeIndicator = document.createElement('div');
            realTimeIndicator.id = 'realTimeIndicator';
            realTimeIndicator.className = 'alert alert-info mb-3';
            realTimeIndicator.style.cssText = 'display: none;';
            realTimeIndicator.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-sync-alt fa-spin me-2"></i>
                        <strong>Real-time Updates Active</strong>
                        <span class="ms-2" id="lastUpdateTime">Last update: Just now</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="toggleRealTimeNotifications()">
                            <i class="fas fa-bell me-1"></i>
                            <span id="notificationToggleText">Notifications ON</span>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshDataNow()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh Now
                        </button>
                    </div>
                </div>
            `;
            statusContainer.insertBefore(realTimeIndicator, statusContainer.firstChild);
        }
    }
    
    // Add notification settings
    function addNotificationSettings() {
        // This would add notification permission requests and settings
        console.log('Notification settings initialized');
    }
    
    // Start auto-refresh functionality
    function startAutoRefresh() {
        console.log('Starting auto-refresh...');
        
        // Refresh every 30 seconds
        autoRefreshInterval = setInterval(() => {
            if (isConnected) {
                console.log('Auto-refreshing data...');
                refreshData();
            }
        }, 30000); // 30 seconds
        
        // Show real-time indicator
        const indicator = document.getElementById('realTimeIndicator');
        if (indicator) {
            indicator.style.display = 'block';
        }
        
        isConnected = true;
    }
    
    // Stop auto-refresh
    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
        isConnected = false;
        
        const indicator = document.getElementById('realTimeIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }
    
    // Refresh data (users and products)
    async function refreshData() {
        try {
            console.log('Refreshing all data...');
            lastUpdateTime = new Date();
            
            // Update last update time
            const lastUpdateElement = document.getElementById('lastUpdateTime');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;
            }
            
            // Refresh users if on users tab
            const usersTab = document.getElementById('users-tab');
            if (usersTab && usersTab.classList.contains('active')) {
                await loadUsers();
            }
            
            // Refresh products if on products tab
            const productsTab = document.getElementById('products-tab');
            if (productsTab && productsTab.classList.contains('active')) {
                await loadProducts();
            }
            
            console.log('Data refresh completed');
            
        } catch (error) {
            console.error('Error refreshing data:', error);
        }
    }
    
    // Manual refresh function
    async function refreshDataNow() {
        console.log('Manual refresh triggered');
        await refreshData();
        showSuccess('Data refreshed successfully!');
    }
    
    // Toggle real-time notifications
    function toggleRealTimeNotifications() {
        realTimeNotifications = !realTimeNotifications;
        const toggleText = document.getElementById('notificationToggleText');
        if (toggleText) {
            toggleText.textContent = realTimeNotifications ? 'Notifications ON' : 'Notifications OFF';
        }
        
        if (realTimeNotifications) {
            showSuccess('Real-time notifications enabled');
        } else {
            showSuccess('Real-time notifications disabled');
        }
    }
    
    // Show real-time notification
    function showRealTimeNotification(message, type = 'info') {
        if (!realTimeNotifications) return;
        
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-bell me-2"></i>
                <div>
                    <strong>Real-time Update</strong><br>
                    <small>${message}</small>
                </div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }
    
    // Enhanced approval function with real-time updates
    async function approveUserRealTime(userId, userData) {
        try {
            console.log('Real-time user approval:', userId);
            
            // Show loading state
            showRealTimeNotification('Approving user...', 'info');
            
            // Perform approval
            await updateUserStatus('verified');
            
            // Show success notification
            showRealTimeNotification(`User ${userData.firstName || userData.username || 'Unknown'} approved successfully!`, 'success');
            
            // Update UI immediately
            if (usersData[userId]) {
                usersData[userId].verificationStatus = 'verified';
                usersData[userId].reviewedAt = new Date().toISOString();
                usersData[userId].reviewedBy = 'admin-real-time';
            }
            
            // Refresh display
            displayUsers(usersData);
            updateDashboardStats(usersData);
            
        } catch (error) {
            console.error('Error in real-time approval:', error);
            showRealTimeNotification(`Failed to approve user: ${error.message}`, 'danger');
        }
    }
    
    // Enhanced rejection function with real-time updates
    async function rejectUserRealTime(userId, userData, reason = '') {
        try {
            console.log('Real-time user rejection:', userId, reason);
            
            // Show loading state
            showRealTimeNotification('Rejecting user...', 'info');
            
            // Perform rejection
            await updateUserStatus('rejected');
            
            // Show success notification
            const reasonText = reason ? ` (${reason})` : '';
            showRealTimeNotification(`User ${userData.firstName || userData.username || 'Unknown'} rejected${reasonText}`, 'warning');
            
            // Update UI immediately
            if (usersData[userId]) {
                usersData[userId].verificationStatus = 'rejected';
                usersData[userId].reviewedAt = new Date().toISOString();
                usersData[userId].reviewedBy = 'admin-real-time';
                if (reason) {
                    usersData[userId].rejectionReason = reason;
                }
            }
            
            // Refresh display
            displayUsers(usersData);
            updateDashboardStats(usersData);
            
        } catch (error) {
            console.error('Error in real-time rejection:', error);
            showRealTimeNotification(`Failed to reject user: ${error.message}`, 'danger');
        }
    }
    
    // Enhanced product approval with real-time updates
    async function approveProductRealTime(productId, productData) {
        try {
            console.log('Real-time product approval:', productId);
            
            // Show loading state
            showRealTimeNotification('Approving product...', 'info');
            
            // Perform approval
            await approveProduct(productId);
            
            // Show success notification
            showRealTimeNotification(`Product "${productData.title || 'Untitled'}" approved successfully!`, 'success');
            
            // Update local data immediately
            if (productsData[productId]) {
                productsData[productId].moderationStatus = 'approved';
                productsData[productId].reviewedAt = new Date().toISOString();
                productsData[productId].reviewedBy = 'admin-real-time';
            }
            
            // Refresh display
            displayProducts(productsData);
            updateProductStats(productsData);
            
        } catch (error) {
            console.error('Error in real-time product approval:', error);
            showRealTimeNotification(`Failed to approve product: ${error.message}`, 'danger');
        }
    }
    
    // Enhanced product rejection with real-time updates
    async function rejectProductRealTime(productId, productData, reason = '') {
        try {
            console.log('Real-time product rejection:', productId, reason);
            
            // Show loading state
            showRealTimeNotification('Rejecting product...', 'info');
            
            // Perform rejection
            await confirmRejectProduct();
            
            // Show success notification
            const reasonText = reason ? ` (${reason})` : '';
            showRealTimeNotification(`Product "${productData.title || 'Untitled'}" rejected${reasonText}`, 'warning');
            
            // Update local data immediately
            if (productsData[productId]) {
                productsData[productId].moderationStatus = 'rejected';
                productsData[productId].rejectionReason = reason;
                productsData[productId].reviewedAt = new Date().toISOString();
                productsData[productId].reviewedBy = 'admin-real-time';
            }
            
            // Refresh display
            displayProducts(productsData);
            updateProductStats(productsData);
            
        } catch (error) {
            console.error('Error in real-time product rejection:', error);
            showRealTimeNotification(`Failed to reject product: ${error.message}`, 'danger');
        }
    }
    
    // ==================== END REAL-TIME FUNCTIONALITY ====================

    // Update connection status
    function updateConnectionStatus(message, type) {
        const statusDiv = document.getElementById('connectionStatus');
        if (!statusDiv) {
            console.log(`Connection Status: ${message} (${type})`);
            return;
        }
        
        const iconClass = type === 'success' ? 'fa-check-circle' : 
                         type === 'error' ? 'fa-exclamation-triangle' : 
                         type === 'warning' ? 'fa-exclamation-triangle' : 'fa-spinner fa-spin';
        
        statusDiv.className = `alert connection-status ${type}`;
        statusDiv.innerHTML = `<i class="fas ${iconClass} me-2"></i>${message}`;
        statusDiv.style.display = 'block';
        
        // Auto-hide success messages after 3 seconds
        if (type === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
    }

    // Firebase REST API helper functions
    function convertFirestoreValue(field) {
        if (!field) return null;
        
        if (field.stringValue !== undefined) return field.stringValue;
        if (field.integerValue !== undefined) return parseInt(field.integerValue);
        if (field.doubleValue !== undefined) return parseFloat(field.doubleValue);
        if (field.booleanValue !== undefined) return field.booleanValue;
        if (field.timestampValue !== undefined) return new Date(field.timestampValue);
        if (field.mapValue !== undefined) {
            const result = {};
            if (field.mapValue.fields) {
                Object.keys(field.mapValue.fields).forEach(key => {
                    result[key] = convertFirestoreValue(field.mapValue.fields[key]);
                });
            }
            return result;
        }
        if (field.arrayValue !== undefined) {
            if (field.arrayValue.values) {
                return field.arrayValue.values.map(convertFirestoreValue);
            }
            return [];
        }
        return null;
    }

    // Convert entire Firestore document to product object - SIMPLIFIED VERSION
    function convertFirestoreDocument(fields) {
        if (!fields) return null;
        
        console.log('Converting fields:', fields);
        
        const product = {};
        
        // Convert each field with better error handling
        Object.keys(fields).forEach(key => {
            try {
                const field = fields[key];
                let value = null;
                
                // Handle different Firestore field types
                if (field.stringValue !== undefined) {
                    value = field.stringValue;
                } else if (field.integerValue !== undefined) {
                    value = parseInt(field.integerValue);
                } else if (field.doubleValue !== undefined) {
                    value = parseFloat(field.doubleValue);
                } else if (field.booleanValue !== undefined) {
                    value = field.booleanValue;
                } else if (field.timestampValue !== undefined) {
                    value = new Date(field.timestampValue);
                } else if (field.arrayValue !== undefined && field.arrayValue.values) {
                    value = field.arrayValue.values.map(v => {
                        if (v.stringValue !== undefined) return v.stringValue;
                        if (v.integerValue !== undefined) return parseInt(v.integerValue);
                        if (v.doubleValue !== undefined) return parseFloat(v.doubleValue);
                        if (v.booleanValue !== undefined) return v.booleanValue;
                        return v;
                    });
                    // Special handling for imageUrls to ensure it's always an array
                    if (key === 'imageUrls') {
                        console.log(`üì∏ Converting imageUrls array:`, value);
                        console.log(`üì∏ imageUrls length:`, value.length);
                    }
                } else if (field.mapValue !== undefined && field.mapValue.fields) {
                    // Handle nested objects (like faceData)
                    console.log(`Converting mapValue for field ${key}:`, field.mapValue.fields);
                    value = convertFirestoreDocument(field.mapValue.fields);
                    console.log(`Converted mapValue for ${key}:`, value);
                }
                
                if (value !== null && value !== undefined) {
                    product[key] = value;
                }
            } catch (error) {
                console.warn(`Error converting field ${key}:`, error);
            }
        });
        
        // Set required defaults
        product.moderationStatus = product.moderationStatus || 'pending';
        product.status = product.status || 'active';
        product.views = product.views || 0;
        product.isVerified = product.isVerified || false;
        product.likedBy = product.likedBy || [];
        product.comments = product.comments || [];
        
        console.log('Converted product:', product);
        return product;
    }



    // Load users from Firebase REST API
    async function loadUsers() {
        try {
            console.log('Loading users from marketsafe database via REST API...');
            const response = await fetch(`${FIREBASE_REST_BASE}/users?key=${FIREBASE_CONFIG.apiKey}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Raw Firebase response:', data);
            
            // Reset usersData for this load
            usersData = {};
            
            if (data.documents) {
                data.documents.forEach(doc => {
                    console.log('=== DOCUMENT CONVERSION DEBUG ===');
                    console.log('Raw document:', doc);
                    console.log('Document name:', doc.name);
                    console.log('Document fields:', doc.fields);
                    
                    const userId = doc.name.split('/').pop();
                    const user = convertFirestoreDocument(doc.fields);
                    user.id = userId; // Add the user ID
                    console.log('Converted user:', user);
                    console.log('=== END DOCUMENT CONVERSION DEBUG ===');
                    
                    usersData[userId] = user;
                });
            }
            
            console.log('Processed users data:', usersData);
            console.log('Sample user data:', Object.values(usersData)[0]);
            
            // Check if the updated user still has their data
            if (selectedUserId && usersData[selectedUserId]) {
                console.log('=== POST-UPDATE USER DATA CHECK ===');
                console.log('Updated user data after reload:', usersData[selectedUserId]);
                console.log('User firstName after update:', usersData[selectedUserId].firstName);
                console.log('User email after update:', usersData[selectedUserId].email);
                console.log('User faceData after update:', usersData[selectedUserId].faceData);
                console.log('=== END POST-UPDATE CHECK ===');
            }
            
            console.log(`Loaded ${Object.keys(usersData).length} users from marketsafe database`);
            displayUsers(usersData);
            updateDashboardStats(usersData);
            
        } catch (error) {
            console.error('Error loading users:', error);
            updateConnectionStatus(`Failed to connect to marketsafe database: ${error.message}`, 'error');
            showError('Failed to load users: ' + error.message);
        }
    }

    // Display users in table
    function displayUsers(users) {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';

        if (Object.keys(users).length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h5>No users found</h5>
                            <p>No users have signed up yet.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        Object.entries(users).forEach(([userId, user]) => {
            const row = createUserRow(userId, user);
            tbody.appendChild(row);
        });
    }

    // Create user row
    function createUserRow(userId, user) {
        const row = document.createElement('tr');
        const status = user.verificationStatus || 'pending';
        
        // Face verification status
        const faceData = user.faceData || {};
        console.log('Face verification data for user:', userId, faceData);
        
        // Check for face verification data in multiple possible locations
        const blinkCompleted = 
            faceData.blinkCompleted === true ||
            faceData.blinkCompleted === 'true' ||
            faceData.blink_completed === true ||
            faceData.blink_completed === 'true' ||
            user.blinkCompleted === true ||
            user.blinkCompleted === 'true';
        
        const moveCloserCompleted = 
            faceData.moveCloserCompleted === true ||
            faceData.moveCloserCompleted === 'true' ||
            faceData.move_closer_completed === true ||
            faceData.move_closer_completed === 'true' ||
            user.moveCloserCompleted === true ||
            user.moveCloserCompleted === 'true';
        
        const headMovementCompleted = 
            faceData.headMovementCompleted === true ||
            faceData.headMovementCompleted === 'true' ||
            faceData.head_movement_completed === true ||
            faceData.head_movement_completed === 'true' ||
            user.headMovementCompleted === true ||
            user.headMovementCompleted === 'true';
        
        console.log('Checking face verification fields:');
        console.log('blinkCompleted:', blinkCompleted);
        console.log('moveCloserCompleted:', moveCloserCompleted);
        console.log('headMovementCompleted:', headMovementCompleted);
        
        const faceSteps = [
            { name: 'Blink', completed: blinkCompleted },
            { name: 'Move Closer', completed: moveCloserCompleted },
            { name: 'Head Movement', completed: headMovementCompleted }
        ];
        
        console.log('Face steps status:', faceSteps);
        
        const faceStepsHtml = faceSteps.map(step => 
            `<span class="verification-badge ${step.completed ? 'completed' : 'pending'}">${step.name}</span>`
        ).join(' ');
        
        // Profile photo handling - prioritize profilePictureUrl (newer field)
        const profilePhotoUrl = user.profilePictureUrl || user.profilePhotoUrl;
        console.log(`User ${userId} profile photos:`);
        console.log(`  - profilePictureUrl: ${user.profilePictureUrl}`);
        console.log(`  - profilePhotoUrl: ${user.profilePhotoUrl}`);
        console.log(`  - Using: ${profilePhotoUrl}`);
        
        let profilePhotoHtml;
        if (profilePhotoUrl && profilePhotoUrl.trim() !== '') {
            profilePhotoHtml = `
                <div class="profile-pic-container me-3" style="position: relative;">
                    <img src="${profilePhotoUrl}" alt="Profile" class="profile-pic-small" 
                         onerror="console.log('Profile photo failed to load (CORS or 404):', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';"
                         onload="console.log('Profile photo loaded successfully:', this.src); this.nextElementSibling.style.display='none';">
                    <div class="user-avatar" style="display: none; position: absolute; top: 0; left: 0;">${(user.firstName || user.username || 'U')[0].toUpperCase()}</div>
                </div>
            `;
        } else {
            profilePhotoHtml = `<div class="user-avatar me-3">${(user.firstName || user.username || 'U')[0].toUpperCase()}</div>`;
        }

        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    ${profilePhotoHtml}
                    <div>
                        <div class="fw-bold">${user.firstName || user.username || 'Unknown User'}</div>
                        <small class="text-muted">ID: ${userId.substring(0, 8)}...</small>
                    </div>
                </div>
            </td>
            <td>
                <div>${user.email || 'N/A'}</div>
                <small class="text-muted">${user.phoneNumber || 'No phone'}</small>
            </td>
            <td>
                <span class="status-badge status-${status}">${status.toUpperCase()}</span>
            </td>
            <td>${faceStepsHtml}</td>
            <td>${formatDate(user.createdAt)}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="viewUser('${userId}')">
                    <i class="fas fa-eye me-1"></i>View
                </button>
            </td>
        `;
        
        return row;
    }

    // Filter users by search term
    function filterUsers(searchTerm) {
        const filteredUsers = {};
        Object.entries(usersData).forEach(([userId, user]) => {
            const searchableText = `
                ${user.firstName || ''}
                ${user.lastName || ''}
                ${user.username || ''}
                ${user.email || ''}
                ${user.phoneNumber || ''}
            `.toLowerCase();
            
            if (searchableText.includes(searchTerm.toLowerCase())) {
                filteredUsers[userId] = user;
            }
        });
        
        displayUsers(filteredUsers);
    }

    // Filter users by status
    function filterUsersByStatus(status) {
        if (!status) {
            displayUsers(usersData);
            return;
        }
        
        const filteredUsers = {};
        Object.entries(usersData).forEach(([userId, user]) => {
            const userStatus = user.verificationStatus || 'pending';
            if (userStatus === status) {
                filteredUsers[userId] = user;
            }
        });
        
        displayUsers(filteredUsers);
    }

    // View user details
    function viewUser(userId) {
        selectedUserId = userId;
        const user = usersData[userId];
        const modalBody = document.getElementById('userModalBody');
        
        // Debug: Log user data
        console.log('=== USER DATA DEBUG ===');
        console.log('Full user object:', user);
        console.log('User firstName:', user.firstName);
        console.log('User lastName:', user.lastName);
        console.log('User username:', user.username);
        console.log('User email:', user.email);
        console.log('User phoneNumber:', user.phoneNumber);
        console.log('User address:', user.address);
        console.log('User age:', user.age);
        console.log('User gender:', user.gender);
        console.log('User birthday:', user.birthday);
        console.log('User faceFeatures:', user.faceFeatures);
        console.log('User faceData:', user.faceData);
        console.log('User verificationStatus:', user.verificationStatus);
        console.log('User createdAt:', user.createdAt);
        console.log('User profilePhotoUrl:', user.profilePhotoUrl);
        console.log('=== END USER DATA DEBUG ===');
        
        // Face verification data - check all possible locations
        const faceData = user.faceData || {};
        console.log('=== COMPLETE USER DATA DEBUG ===');
        console.log('Full user object:', JSON.stringify(user, null, 2));
        console.log('Face data object:', faceData);
        console.log('Face data type:', typeof faceData);
        console.log('Face data keys:', Object.keys(faceData));
        
        // Check for face verification data in different possible locations
        console.log('Checking all possible face verification fields:');
        console.log('user.blinkCompleted:', user.blinkCompleted);
        console.log('user.moveCloserCompleted:', user.moveCloserCompleted);
        console.log('user.headMovementCompleted:', user.headMovementCompleted);
        console.log('user.faceVerification:', user.faceVerification);
        console.log('user.verificationSteps:', user.verificationSteps);
        
        // Check nested face data
        if (faceData && typeof faceData === 'object') {
            console.log('Face data properties:');
            Object.keys(faceData).forEach(key => {
                console.log(`  ${key}:`, faceData[key], typeof faceData[key]);
            });
        }
        
        // Check if faceData is actually an object with properties
        console.log('=== DETAILED FACE DATA ANALYSIS ===');
        console.log('faceData exists:', !!faceData);
        console.log('faceData is object:', typeof faceData === 'object');
        console.log('faceData is null:', faceData === null);
        console.log('faceData is undefined:', faceData === undefined);
        console.log('faceData keys length:', Object.keys(faceData).length);
        
        // Check each specific field
        console.log('faceData.blinkCompleted:', faceData.blinkCompleted, typeof faceData.blinkCompleted);
        console.log('faceData.moveCloserCompleted:', faceData.moveCloserCompleted, typeof faceData.moveCloserCompleted);
        console.log('faceData.headMovementCompleted:', faceData.headMovementCompleted, typeof faceData.headMovementCompleted);
        
        // Check if the data might be nested differently
        console.log('Checking for nested face verification data...');
        if (faceData.faceVerification) {
            console.log('faceData.faceVerification:', faceData.faceVerification);
        }
        if (faceData.verificationSteps) {
            console.log('faceData.verificationSteps:', faceData.verificationSteps);
        }
        
        console.log('=== END COMPLETE USER DATA DEBUG ===');
        
        // Profile photo URL - use same priority as table
        const profilePhotoUrl = user.profilePictureUrl || user.profilePhotoUrl;
        console.log('Modal profile photos:');
        console.log('  - profilePictureUrl:', user.profilePictureUrl);
        console.log('  - profilePhotoUrl:', user.profilePhotoUrl);
        console.log('  - Using for modal:', profilePhotoUrl);
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">Personal Information</h6>
                    <div class="mb-3">
                        <strong>First Name:</strong> ${user.firstName || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Last Name:</strong> ${user.lastName || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Username:</strong> ${user.username || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Email:</strong> ${user.email || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Phone:</strong> ${user.phoneNumber || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Address:</strong> ${user.address || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Age:</strong> ${user.age || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Gender:</strong> ${user.gender || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Birthday:</strong> ${formatDate(user.birthday)}
                    </div>
                </div>
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">Account Information</h6>
                    <div class="mb-3">
                        <strong>User ID:</strong> 
                        <code>${userId}</code>
                    </div>
                    <div class="mb-3">
                        <strong>Registration Date:</strong> ${formatDate(user.createdAt)}
                    </div>
                    <div class="mb-3">
                        <strong>Status:</strong> 
                        <span class="status-badge status-${user.verificationStatus || 'pending'}">
                            ${(user.verificationStatus || 'pending').toUpperCase()}
                        </span>
                    </div>
                    <!-- Profile Photo Section -->
                    ${profilePhotoUrl ? `
                    <div class="mb-3">
                        <strong>Profile Photo:</strong>
                        <div class="row mt-2">
                            <div class="col-md-8">
                                <div class="face-image-container">
                                    <img src="${profilePhotoUrl}" alt="Profile Photo" class="face-image" 
                                         onclick="showFaceImagePreview('${profilePhotoUrl}', 'Profile Photo')" 
                                         onerror="console.log('Modal profile photo failed to load:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';"
                                         onload="console.log('Modal profile photo loaded successfully:', this.src); this.nextElementSibling.style.display='none';"
                                         style="cursor: pointer;" title="Click to enlarge">
                                    <div class="face-image-label" style="display: none;">Profile Photo</div>
                                    <div class="text-muted" style="display: none; padding: 20px; text-align: center;">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Profile photo failed to load
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : `
                    <div class="mb-3">
                        <strong>Profile Photo:</strong>
                        <div class="text-muted">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            No profile photo uploaded
                        </div>
                    </div>
                    `}
                    ${user.faceFeatures ? `
                    <div class="mb-3">
                        <strong>Face Features:</strong> ${user.faceFeatures.featureCount || 0} dimensions stored
                        ${user.faceFeatures.extractedFrom ? `<br><small class="text-muted">Extracted from: ${user.faceFeatures.extractedFrom}</small>` : ''}
                        ${user.faceFeatures.extractionTimestamp ? `<br><small class="text-muted">Extracted: ${new Date(user.faceFeatures.extractionTimestamp).toLocaleString()}</small>` : ''}
                    </div>
                    ` : ''}
                </div>
            </div>
            
            <hr>
            
            <div class="row">
                <div class="col-12">
                    <h6 class="text-muted mb-3">Face Verification Status</h6>
                    <div class="d-flex gap-3 flex-wrap">
                        <div class="verification-badge ${(faceData.blinkCompleted === true || faceData.blinkCompleted === 'true' || faceData.blink_completed === true || faceData.blink_completed === 'true' || user.blinkCompleted === true || user.blinkCompleted === 'true') ? 'completed' : 'pending'}">
                            <i class="fas fa-${(faceData.blinkCompleted === true || faceData.blinkCompleted === 'true' || faceData.blink_completed === true || faceData.blink_completed === 'true' || user.blinkCompleted === true || user.blinkCompleted === 'true') ? 'check' : 'times'} me-1"></i>
                            Blink Test
                        </div>
                        <div class="verification-badge ${(faceData.moveCloserCompleted === true || faceData.moveCloserCompleted === 'true' || faceData.move_closer_completed === true || faceData.move_closer_completed === 'true' || user.moveCloserCompleted === true || user.moveCloserCompleted === 'true') ? 'completed' : 'pending'}">
                            <i class="fas fa-${(faceData.moveCloserCompleted === true || faceData.moveCloserCompleted === 'true' || faceData.move_closer_completed === true || faceData.move_closer_completed === 'true' || user.moveCloserCompleted === true || user.moveCloserCompleted === 'true') ? 'check' : 'times'} me-1"></i>
                            Move Closer Test
                        </div>
                        <div class="verification-badge ${(faceData.headMovementCompleted === true || faceData.headMovementCompleted === 'true' || faceData.head_movement_completed === true || faceData.head_movement_completed === 'true' || user.headMovementCompleted === true || user.headMovementCompleted === 'true') ? 'completed' : 'pending'}">
                            <i class="fas fa-${(faceData.headMovementCompleted === true || faceData.headMovementCompleted === 'true' || faceData.head_movement_completed === true || faceData.head_movement_completed === 'true' || user.headMovementCompleted === true || user.headMovementCompleted === 'true') ? 'check' : 'times'} me-1"></i>
                            Head Movement Test
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Show/hide action buttons based on current status
        const status = user.verificationStatus || 'pending';
        const approveBtn = document.getElementById('approveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        const deleteUserBtn = document.getElementById('deleteUserBtn');
        
        if (status === 'pending') {
            approveBtn.style.display = 'inline-block';
            rejectBtn.style.display = 'inline-block';
        } else {
            approveBtn.style.display = 'none';
            rejectBtn.style.display = 'none';
        }
        
        // Show delete button if admin has permission
        if (currentUserPermissions && currentUserPermissions.canDeleteUsers) {
            deleteUserBtn.style.display = 'inline-block';
        } else {
            deleteUserBtn.style.display = 'none';
        }
        
        new bootstrap.Modal(document.getElementById('userModal')).show();
    }

    // Update user verification status using REST API
    async function updateUserStatus(status) {
        if (!selectedUserId) return;
        
        console.log('=== UPDATE USER STATUS DEBUG ===');
        console.log('Selected user ID:', selectedUserId);
        console.log('New status:', status);
        
        // Get current user data before update
        const currentUser = usersData[selectedUserId];
        console.log('Current user data before update:', currentUser);
        
        try {
            // First, get the current document to preserve all existing data
            console.log('Getting current document before update...');
            const getResponse = await fetch(
                `${FIREBASE_REST_BASE}/users/${selectedUserId}?key=${FIREBASE_CONFIG.apiKey}`
            );
            
            if (!getResponse.ok) {
                throw new Error(`Failed to get current document: ${getResponse.status}`);
            }
            
            const currentDoc = await getResponse.json();
            console.log('Current document from Firestore:', currentDoc);
            
            // Merge current data with new fields
            const updateData = {
                fields: {
                    ...currentDoc.fields, // Preserve all existing fields
                    verificationStatus: { stringValue: status },
                    reviewedAt: { timestampValue: new Date().toISOString() },
                    reviewedBy: { stringValue: 'admin-rest-api' }
                }
            };
            
            console.log('Update data being sent (with preserved fields):', updateData);

            const response = await fetch(
                `${FIREBASE_REST_BASE}/users/${selectedUserId}?key=${FIREBASE_CONFIG.apiKey}`,
                {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                }
            );

            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Response error:', errorText);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const responseData = await response.json();
            console.log('Response data:', responseData);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            
            // Use real-time notification instead of regular success message
            if (realTimeNotifications) {
                showRealTimeNotification(`User ${status} successfully!`, 'success');
            } else {
                showSuccess(`User ${status} successfully!`);
            }
            
            // Update the local user data immediately
            if (usersData[selectedUserId]) {
                usersData[selectedUserId].verificationStatus = status;
                usersData[selectedUserId].reviewedAt = new Date().toISOString();
                usersData[selectedUserId].reviewedBy = 'admin-rest-api';
                console.log('Updated local user data:', usersData[selectedUserId]);
            }
            
            // Refresh data
            console.log('Reloading users after status update...');
            loadUsers();
            
        } catch (error) {
            console.error('Error updating user status:', error);
            if (realTimeNotifications) {
                showRealTimeNotification(`Error updating user status: ${error.message}`, 'danger');
            } else {
                showError('Error updating user status: ' + error.message);
            }
        }
    }

    // Delete user function - deletes from both Firestore and Luxand, plus all related data
    async function deleteUser() {
        if (!selectedUserId) {
            showError('No user selected');
            return;
        }

        const user = usersData[selectedUserId];
        if (!user) {
            showError('User data not found');
            return;
        }

        const userEmail = user.email || '';
        const userPhone = user.phoneNumber || '';
        const userLuxandUuid = user.luxandUuid || (user.luxand && user.luxand.uuid) || '';
        const userName = user.firstName || user.username || 'User';
        
        // Confirmation dialog
        const confirmMessage = `Are you sure you want to delete "${userName}" (${userEmail || userPhone})?\n\n` +
            'This will permanently delete:\n' +
            '‚Ä¢ User account from Firestore\n' +
            '‚Ä¢ Face data from Luxand\n' +
            '‚Ä¢ All posted products\n' +
            '‚Ä¢ All comments\n' +
            '‚Ä¢ All messages and conversations\n' +
            '‚Ä¢ All notifications\n' +
            '‚Ä¢ All reports\n' +
            '‚Ä¢ All offers\n' +
            '‚Ä¢ Follow relationships\n\n' +
            'This action CANNOT be undone!';
        
        if (!confirm(confirmMessage)) {
            return;
        }

        try {
            console.log('üóëÔ∏è Starting user deletion process...');
            console.log('User ID:', selectedUserId);
            console.log('User Email:', userEmail);
            console.log('User Phone:', userPhone);
            console.log('User Luxand UUID:', userLuxandUuid);
            
            // Show loading state
            const deleteBtn = document.getElementById('deleteUserBtn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
            
            let deletedCount = {
                luxand: 0,
                products: 0,
                comments: 0,
                conversations: 0,
                messages: 0,
                notifications: 0,
                reports: 0,
                offers: 0,
                followRelations: 0
            };

            // Step 1: Delete from Luxand (try all available identifiers)
            if (userEmail || userPhone || userLuxandUuid) {
                try {
                    console.log('üîç Step 1: Deleting from Luxand...');
                    const deletePayload = {
                        userId: selectedUserId
                    };
                    if (userEmail) deletePayload.email = userEmail;
                    if (userPhone) deletePayload.phoneNumber = userPhone;
                    if (userLuxandUuid) deletePayload.luxandUuid = userLuxandUuid;
                    
                    console.log('üì§ Sending delete request with payload:', deletePayload);
                    const luxandResponse = await fetch(`${BACKEND_API_URL}/api/delete-user`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(deletePayload)
                    });
                    
                    if (luxandResponse.ok) {
                        const luxandResult = await luxandResponse.json();
                        deletedCount.luxand = luxandResult.luxandDeleted || 0;
                        console.log(`‚úÖ Deleted ${deletedCount.luxand} face(s) from Luxand`);
                        if (luxandResult.errors && luxandResult.errors.length > 0) {
                            console.warn('‚ö†Ô∏è Some errors during Luxand deletion:', luxandResult.errors);
                        }
                        if (deletedCount.luxand === 0 && (userEmail || userPhone || userLuxandUuid)) {
                            console.warn('‚ö†Ô∏è No faces were deleted from Luxand. This might mean:');
                            console.warn('   - The face was not enrolled in Luxand');
                            console.warn('   - The phone/email format does not match what is stored in Luxand');
                            console.warn('   - Check backend logs for detailed matching information');
                        }
                    } else {
                        const errorText = await luxandResponse.text();
                        console.error('‚ùå Failed to delete from Luxand:', errorText);
                        console.warn('‚ö†Ô∏è Continuing with Firestore deletion...');
                    }
                } catch (luxandError) {
                    console.warn('‚ö†Ô∏è Error deleting from Luxand:', luxandError);
                }
            }

            // Step 2: Delete all products by this user
            try {
                console.log('üîç Step 2: Deleting products...');
                const productsResponse = await fetch(`${FIREBASE_REST_BASE}/products?key=${FIREBASE_CONFIG.apiKey}`);
                if (productsResponse.ok) {
                    const productsData = await productsResponse.json();
                    if (productsData.documents) {
                        for (const doc of productsData.documents) {
                            const productId = doc.name.split('/').pop();
                            const productFields = doc.fields;
                            const sellerId = productFields.sellerId?.stringValue || productFields.userId?.stringValue;
                            
                            if (sellerId === selectedUserId) {
                                await fetch(`${FIREBASE_REST_BASE}/products/${productId}?key=${FIREBASE_CONFIG.apiKey}`, {
                                    method: 'DELETE'
                                });
                                deletedCount.products++;
                                console.log(`‚úÖ Deleted product: ${productId}`);
                            }
                        }
                    }
                }
            } catch (productsError) {
                console.warn('‚ö†Ô∏è Error deleting products:', productsError);
            }

            // Step 3: Delete all conversations and messages
            try {
                console.log('üîç Step 3: Deleting conversations and messages...');
                const conversationsResponse = await fetch(`${FIREBASE_REST_BASE}/conversations?key=${FIREBASE_CONFIG.apiKey}`);
                if (conversationsResponse.ok) {
                    const conversationsData = await conversationsResponse.json();
                    if (conversationsData.documents) {
                        for (const doc of conversationsData.documents) {
                            const conversationId = doc.name.split('/').pop();
                            const conversationFields = doc.fields;
                            const participants = conversationFields.participants?.arrayValue?.values || [];
                            const participantIds = participants.map(p => p.stringValue || '').filter(id => id);
                            
                            if (participantIds.includes(selectedUserId)) {
                                // Delete all messages in this conversation first
                                try {
                                    const messagesResponse = await fetch(`${FIREBASE_REST_BASE}/conversations/${conversationId}/messages?key=${FIREBASE_CONFIG.apiKey}`);
                                    if (messagesResponse.ok) {
                                        const messagesData = await messagesResponse.json();
                                        if (messagesData.documents) {
                                            for (const msgDoc of messagesData.documents) {
                                                const messageId = msgDoc.name.split('/').pop();
                                                await fetch(`${FIREBASE_REST_BASE}/conversations/${conversationId}/messages/${messageId}?key=${FIREBASE_CONFIG.apiKey}`, {
                                                    method: 'DELETE'
                                                });
                                                deletedCount.messages++;
                                            }
                                        }
                                    }
                                } catch (msgError) {
                                    console.warn('‚ö†Ô∏è Error deleting messages:', msgError);
                                }
                                
                                // Delete the conversation
                                await fetch(`${FIREBASE_REST_BASE}/conversations/${conversationId}?key=${FIREBASE_CONFIG.apiKey}`, {
                                    method: 'DELETE'
                                });
                                deletedCount.conversations++;
                                console.log(`‚úÖ Deleted conversation: ${conversationId}`);
                            }
                        }
                    }
                }
            } catch (conversationsError) {
                console.warn('‚ö†Ô∏è Error deleting conversations:', conversationsError);
            }

            // Step 4: Delete all notifications
            try {
                console.log('üîç Step 4: Deleting notifications...');
                const notificationsResponse = await fetch(`${FIREBASE_REST_BASE}/notifications?key=${FIREBASE_CONFIG.apiKey}`);
                if (notificationsResponse.ok) {
                    const notificationsData = await notificationsResponse.json();
                    if (notificationsData.documents) {
                        for (const doc of notificationsData.documents) {
                            const notificationId = doc.name.split('/').pop();
                            const notificationFields = doc.fields;
                            const userId = notificationFields.userId?.stringValue;
                            
                            if (userId === selectedUserId) {
                                await fetch(`${FIREBASE_REST_BASE}/notifications/${notificationId}?key=${FIREBASE_CONFIG.apiKey}`, {
                                    method: 'DELETE'
                                });
                                deletedCount.notifications++;
                            }
                        }
                    }
                }
            } catch (notificationsError) {
                console.warn('‚ö†Ô∏è Error deleting notifications:', notificationsError);
            }

            // Step 5: Delete all reports (where user is reporter or reported)
            try {
                console.log('üîç Step 5: Deleting reports...');
                const reportsResponse = await fetch(`${FIREBASE_REST_BASE}/reports?key=${FIREBASE_CONFIG.apiKey}`);
                if (reportsResponse.ok) {
                    const reportsData = await reportsResponse.json();
                    if (reportsData.documents) {
                        for (const doc of reportsData.documents) {
                            const reportId = doc.name.split('/').pop();
                            const reportFields = doc.fields;
                            const reporterId = reportFields.reporterId?.stringValue;
                            const reportedUserId = reportFields.reportedUserId?.stringValue;
                            
                            if (reporterId === selectedUserId || reportedUserId === selectedUserId) {
                                await fetch(`${FIREBASE_REST_BASE}/reports/${reportId}?key=${FIREBASE_CONFIG.apiKey}`, {
                                    method: 'DELETE'
                                });
                                deletedCount.reports++;
                            }
                        }
                    }
                }
            } catch (reportsError) {
                console.warn('‚ö†Ô∏è Error deleting reports:', reportsError);
            }

            // Step 6: Delete all offers (where user is buyer or seller)
            try {
                console.log('üîç Step 6: Deleting offers...');
                const offersResponse = await fetch(`${FIREBASE_REST_BASE}/offers?key=${FIREBASE_CONFIG.apiKey}`);
                if (offersResponse.ok) {
                    const offersData = await offersResponse.json();
                    if (offersData.documents) {
                        for (const doc of offersData.documents) {
                            const offerId = doc.name.split('/').pop();
                            const offerFields = doc.fields;
                            const buyerId = offerFields.buyerId?.stringValue;
                            const sellerId = offerFields.sellerId?.stringValue;
                            
                            if (buyerId === selectedUserId || sellerId === selectedUserId) {
                                await fetch(`${FIREBASE_REST_BASE}/offers/${offerId}?key=${FIREBASE_CONFIG.apiKey}`, {
                                    method: 'DELETE'
                                });
                                deletedCount.offers++;
                            }
                        }
                    }
                }
            } catch (offersError) {
                console.warn('‚ö†Ô∏è Error deleting offers:', offersError);
            }

            // Step 7: Update follow relationships (remove user from followers/following arrays)
            try {
                console.log('üîç Step 7: Cleaning up follow relationships...');
                const allUsersResponse = await fetch(`${FIREBASE_REST_BASE}/users?key=${FIREBASE_CONFIG.apiKey}`);
                if (allUsersResponse.ok) {
                    const allUsersData = await allUsersResponse.json();
                    if (allUsersData.documents) {
                        for (const doc of allUsersData.documents) {
                            const otherUserId = doc.name.split('/').pop();
                            if (otherUserId === selectedUserId) continue;
                            
                            const userFields = doc.fields;
                            const followers = userFields.followers?.arrayValue?.values || [];
                            const following = userFields.following?.arrayValue?.values || [];
                            
                            let needsUpdate = false;
                            const updatedFields = { ...userFields };
                            
                            if (followers.some(f => (f.stringValue || '') === selectedUserId)) {
                                updatedFields.followers = {
                                    arrayValue: {
                                        values: followers.filter(f => (f.stringValue || '') !== selectedUserId)
                                    }
                                };
                                needsUpdate = true;
                                deletedCount.followRelations++;
                            }
                            
                            if (following.some(f => (f.stringValue || '') === selectedUserId)) {
                                updatedFields.following = {
                                    arrayValue: {
                                        values: following.filter(f => (f.stringValue || '') !== selectedUserId)
                                    }
                                };
                                needsUpdate = true;
                                deletedCount.followRelations++;
                            }
                            
                            if (needsUpdate) {
                                await fetch(`${FIREBASE_REST_BASE}/users/${otherUserId}?key=${FIREBASE_CONFIG.apiKey}`, {
                                    method: 'PATCH',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ fields: updatedFields })
                                });
                            }
                        }
                    }
                }
            } catch (followError) {
                console.warn('‚ö†Ô∏è Error cleaning up follow relationships:', followError);
            }

            // Step 8: Remove user from product comments and likedBy arrays
            try {
                console.log('üîç Step 8: Cleaning up product interactions...');
                const productsResponse = await fetch(`${FIREBASE_REST_BASE}/products?key=${FIREBASE_CONFIG.apiKey}`);
                if (productsResponse.ok) {
                    const productsData = await productsResponse.json();
                    if (productsData.documents) {
                        for (const doc of productsData.documents) {
                            const productId = doc.name.split('/').pop();
                            const productFields = doc.fields;
                            let needsUpdate = false;
                            const updatedFields = { ...productFields };
                            
                            const likedBy = productFields.likedBy?.arrayValue?.values || [];
                            if (likedBy.some(l => (l.stringValue || '') === selectedUserId)) {
                                updatedFields.likedBy = {
                                    arrayValue: {
                                        values: likedBy.filter(l => (l.stringValue || '') !== selectedUserId)
                                    }
                                };
                                needsUpdate = true;
                                deletedCount.comments++;
                            }
                            
                            const comments = productFields.comments?.arrayValue?.values || [];
                            if (comments.some(c => {
                                const commentData = c.mapValue?.fields || {};
                                const commentUserId = commentData.userId?.stringValue;
                                return commentUserId === selectedUserId;
                            })) {
                                updatedFields.comments = {
                                    arrayValue: {
                                        values: comments.filter(c => {
                                            const commentData = c.mapValue?.fields || {};
                                            const commentUserId = commentData.userId?.stringValue;
                                            return commentUserId !== selectedUserId;
                                        })
                                    }
                                };
                                needsUpdate = true;
                                deletedCount.comments++;
                            }
                            
                            if (needsUpdate) {
                                await fetch(`${FIREBASE_REST_BASE}/products/${productId}?key=${FIREBASE_CONFIG.apiKey}`, {
                                    method: 'PATCH',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ fields: updatedFields })
                                });
                            }
                        }
                    }
                }
            } catch (productInteractionsError) {
                console.warn('‚ö†Ô∏è Error cleaning up product interactions:', productInteractionsError);
            }

            // Step 9: Finally, delete the user document itself
            try {
                console.log('üîç Step 9: Deleting user document...');
                const deleteResponse = await fetch(`${FIREBASE_REST_BASE}/users/${selectedUserId}?key=${FIREBASE_CONFIG.apiKey}`, {
                    method: 'DELETE'
                });
                
                if (!deleteResponse.ok && deleteResponse.status !== 404) {
                    throw new Error(`Failed to delete user: ${deleteResponse.status}`);
                }
                console.log('‚úÖ User document deleted');
            } catch (deleteUserError) {
                console.error('‚ùå Error deleting user document:', deleteUserError);
                throw deleteUserError;
            }

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            
            // Show success message with details
            const summary = [
                `‚úÖ User deleted successfully!`,
                `\nDeleted:`,
                `‚Ä¢ ${deletedCount.luxand} face(s) from Luxand`,
                `‚Ä¢ ${deletedCount.products} product(s)`,
                `‚Ä¢ ${deletedCount.comments} comment(s)/like(s)`,
                `‚Ä¢ ${deletedCount.conversations} conversation(s)`,
                `‚Ä¢ ${deletedCount.messages} message(s)`,
                `‚Ä¢ ${deletedCount.notifications} notification(s)`,
                `‚Ä¢ ${deletedCount.reports} report(s)`,
                `‚Ä¢ ${deletedCount.offers} offer(s)`,
                `‚Ä¢ ${deletedCount.followRelations} follow relationship(s)`
            ].join('\n');
            
            alert(summary);
            
            // Refresh users list
            loadUsers();
            
        } catch (error) {
            console.error('‚ùå Error deleting user:', error);
            showError('Failed to delete user: ' + (error.message || 'Unknown error'));
            
            // Re-enable button
            const deleteBtn = document.getElementById('deleteUserBtn');
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete User';
            }
        }
    }

    // Show face image preview in modal
    function showFaceImagePreview(imageUrl, title) {
        document.getElementById('faceImagePreview').src = imageUrl;
        document.getElementById('faceImageTitle').textContent = title;
        new bootstrap.Modal(document.getElementById('faceImageModal')).show();
    }

    // Update dashboard statistics
    function updateDashboardStats(users) {
        console.log('Updating dashboard stats with users:', users);
        
        const stats = {
            total: 0,
            pending: 0,
            verified: 0,
            rejected: 0
        };

        if (users && Object.keys(users).length > 0) {
            Object.values(users).forEach(user => {
                stats.total++;
                const status = user.verificationStatus || 'pending';
                if (stats.hasOwnProperty(status)) {
                    stats[status]++;
                }
            });
        }

        console.log('Calculated stats:', stats);

        // Update the DOM elements with explicit values
        const totalElement = document.getElementById('totalUsers');
        const pendingElement = document.getElementById('pendingUsers');
        const verifiedElement = document.getElementById('verifiedUsers');
        const rejectedElement = document.getElementById('rejectedUsers');

        console.log('Elements found for update:', {
            total: totalElement,
            pending: pendingElement,
            verified: verifiedElement,
            rejected: rejectedElement
        });

        if (totalElement) {
            totalElement.textContent = stats.total.toString();
            console.log('Updated totalUsers to:', stats.total);
        }
        if (pendingElement) {
            pendingElement.textContent = stats.pending.toString();
            console.log('Updated pendingUsers to:', stats.pending);
        }
        if (verifiedElement) {
            verifiedElement.textContent = stats.verified.toString();
            console.log('Updated verifiedUsers to:', stats.verified);
        }
        if (rejectedElement) {
            rejectedElement.textContent = stats.rejected.toString();
            console.log('Updated rejectedUsers to:', stats.rejected);
        }
    }

    // Utility functions
    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        
        let date;
        if (timestamp instanceof Date) {
            date = timestamp;
        } else if (typeof timestamp === 'string') {
            date = new Date(timestamp);
        } else {
            return 'N/A';
        }
        
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function showSuccess(message) {
        // Create a temporary success alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }

    function showError(message) {
        // Create a temporary error alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }

    // Generic alert function
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }

    // Product Moderation Functions
    let productsData = {};
    let selectedProductId = null;

    // Load products from Firestore
    async function loadProducts() {
        try {
            console.log('Loading products from Firestore...');
            updateConnectionStatus('Loading products...', 'info');
            
            // Update loading state in table
            const tbody = document.getElementById('productsTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading products...</td></tr>';
            }
            
            // Add timeout to prevent infinite loading
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            const response = await fetch(`${FIREBASE_REST_BASE}/products?key=${FIREBASE_CONFIG.apiKey}`, {
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            console.log('Products API response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error Response:', errorText);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Products response:', data);
            
            productsData = {};
            if (data.documents && data.documents.length > 0) {
                console.log(`Found ${data.documents.length} documents`);
                
                data.documents.forEach((doc, index) => {
                    try {
                        const productId = doc.name.split('/').pop();
                        const fields = doc.fields;
                        
                        console.log(`Processing document ${index + 1}/${data.documents.length}: ${productId}`);
                        console.log('Raw product fields:', fields);
                        
                        // Convert the document fields to a product object
                        const convertedProduct = convertFirestoreDocument(fields);
                        console.log('Converted product:', convertedProduct);
                        
                        if (convertedProduct && Object.keys(convertedProduct).length > 0) {
                            productsData[productId] = convertedProduct;
                            console.log(`‚úÖ Successfully stored product: ${productId}`);
                            console.log('Product sellerName:', convertedProduct.sellerName);
                            console.log('Product title:', convertedProduct.title);
                        } else {
                            console.warn(`‚ùå Skipping invalid product: ${productId}`);
                        }
                    } catch (error) {
                        console.error(`‚ùå Error processing document ${index + 1}:`, error);
                    }
                });
                
                console.log(`‚úÖ Successfully loaded ${Object.keys(productsData).length} products`);
            } else {
                console.log('‚ÑπÔ∏è No products found in database');
                productsData = {};
            }
            
            displayProducts(productsData);
            updateProductStats(productsData);
            updateConnectionStatus('Products loaded successfully', 'success');
            
        } catch (error) {
            console.error('Error loading products:', error);
            
            let errorMessage = error.message;
            if (error.name === 'AbortError') {
                errorMessage = 'Request timed out. Please try again.';
            }
            
            updateConnectionStatus(`Failed to load products: ${errorMessage}`, 'error');
            
            // Show error in table
            const tbody = document.getElementById('productsTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading products: ${errorMessage}
                            <br><small>Click the debug button (üêõ) for more details</small>
                        </td>
                    </tr>
                `;
            }
        }
    }

    // Display products in table
    function displayProducts(products) {
        const tbody = document.getElementById('productsTableBody');
        if (!tbody) {
            console.error('Products table body not found');
            return;
        }
        
        tbody.innerHTML = '';

        if (!products || Object.keys(products).length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="fas fa-shopping-cart me-2"></i>
                        No products found. Products will appear here once users start creating listings.
                    </td>
                </tr>
            `;
            return;
        }

        Object.entries(products).forEach(([productId, product]) => {
            try {
                const row = document.createElement('tr');
                
                // Debug: Log product structure
                console.log('Processing product:', productId, product);
                
                // Safely get product image with null checks
                let imageUrl = '';
                if (product && product.imageUrl) {
                    imageUrl = product.imageUrl;
                } else if (product && product.imageUrls && Array.isArray(product.imageUrls) && product.imageUrls.length > 0) {
                    imageUrl = product.imageUrls[0];
                }
                
                let imageHtml = '';
                if (product && product.mediaType === 'video' && product.videoThumbnailUrl) {
                    // Video thumbnail with play icon
                    imageHtml = `
                        <div class="position-relative">
                            <img src="${product.videoThumbnailUrl}" alt="Video Thumbnail" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                            <div class="position-absolute top-50 start-50 translate-middle">
                                <i class="fas fa-play-circle text-white" style="font-size: 16px; text-shadow: 0 0 3px rgba(0,0,0,0.8);"></i>
                            </div>
                        </div>
                    `;
                } else if (imageUrl) {
                    // Regular image
                    imageHtml = `<img src="${imageUrl}" alt="Product" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">`;
                } else {
                    // Placeholder
                    imageHtml = '<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;"><i class="fas fa-image text-muted"></i></div>';
                }
                
                // Status badge with safe access
                const status = (product && product.moderationStatus) ? product.moderationStatus : 'pending';
                const statusClass = status === 'approved' ? 'bg-success' : 
                                  status === 'rejected' ? 'bg-danger' : 'bg-warning';
                const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                
                // Created date with safe access
                const createdAt = (product && product.createdAt) ? new Date(product.createdAt).toLocaleDateString() : 'Unknown';
                
                // Check if preview button should be shown
                const hasImageUrls = product && product.imageUrls && Array.isArray(product.imageUrls) && product.imageUrls.length > 0;
                const hasImageUrl = product && product.imageUrl;
                const hasVideo = product && product.mediaType === 'video' && product.videoUrl;
                const shouldShowPreview = hasImageUrls || hasImageUrl || hasVideo;
                
                if (shouldShowPreview) {
                    console.log(`üîò Preview button condition met for ${productId}:`, {
                        hasImageUrls: hasImageUrls,
                        imageUrlsLength: product.imageUrls ? product.imageUrls.length : 0,
                        hasImageUrl: hasImageUrl,
                        hasVideo: hasVideo
                    });
                }
                
                const previewButtonHtml = shouldShowPreview ? `
                    <button class="btn btn-sm btn-outline-info me-1" onclick="console.log('üîò Preview button clicked for:', '${productId}'); previewProductMedia('${productId}');" title="Preview all photos/videos">
                        <i class="fas fa-images"></i>
                    </button>
                ` : '';
                
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            ${imageHtml}
                            <div class="ms-2">
                                <div class="fw-bold">${(product && product.title) ? product.title : 'Untitled'}</div>
                                <small class="text-muted">${(product && product.description) ? product.description.substring(0, 50) + '...' : 'No description'}</small>
                            </div>
                        </div>
                    </td>
                    <td>${(product && product.sellerName) ? product.sellerName : (product && product.sellerId && usersData[product.sellerId]) ? (usersData[product.sellerId].firstName || usersData[product.sellerId].username || 'Unknown') : 'Unknown'}</td>
                    <td>${(product && product.category) ? product.category : 'Unknown'}</td>
                    <td>$${(product && product.price) ? product.price : 0}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${createdAt}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewProduct('${productId}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${previewButtonHtml}
                        ${status === 'pending' ? `
                            <button class="btn btn-sm btn-success me-1" onclick="approveProduct('${productId}')" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-warning me-1" onclick="showRejectModal('${productId}')" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-danger" onclick="showDeleteModal('${productId}')" title="Delete Product">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            } catch (error) {
                console.error('Error processing product:', productId, error);
                // Add error row for this product
                const errorRow = document.createElement('tr');
                errorRow.innerHTML = `
                    <td colspan="7" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error displaying product: ${productId}
                    </td>
                `;
                tbody.appendChild(errorRow);
            }
        });
    }

    // Update product statistics
    function updateProductStats(products) {
        const stats = {
            pending: 0,
            approved: 0,
            rejected: 0,
            total: 0
        };

        if (products && Object.keys(products).length > 0) {
            Object.values(products).forEach(product => {
                // Skip null or undefined products
                if (!product) {
                    console.warn('Skipping null product in stats');
                    return;
                }
                
                stats.total++;
                const status = (product && product.moderationStatus) ? product.moderationStatus : 'pending';
                if (stats.hasOwnProperty(status)) {
                    stats[status]++;
                }
            });
        }

        document.getElementById('pendingProducts').textContent = stats.pending;
        document.getElementById('approvedProducts').textContent = stats.approved;
        document.getElementById('rejectedProducts').textContent = stats.rejected;
        document.getElementById('totalProducts').textContent = stats.total;
    }

    // View product details
    function viewProduct(productId) {
        const product = productsData[productId];
        if (!product) return;

        selectedProductId = productId;
        
        // Update modal content
        document.getElementById('productTitle').textContent = product.title || 'Untitled';
        document.getElementById('productDescription').textContent = product.description || 'No description';
        document.getElementById('productPrice').textContent = product.price || 0;
        document.getElementById('productCondition').textContent = product.condition || 'Unknown';
        document.getElementById('productCategory').textContent = product.category || 'Unknown';
        document.getElementById('productSeller').textContent = product.sellerName || 'Unknown';
        document.getElementById('productCreated').textContent = product.createdAt ? new Date(product.createdAt).toLocaleString() : 'Unknown';
        
        // Status
        const status = product.moderationStatus || 'pending';
        const statusElement = document.getElementById('productStatus');
        statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        statusElement.className = `badge ${status === 'approved' ? 'bg-success' : status === 'rejected' ? 'bg-danger' : 'bg-warning'}`;
        
        // Rejection reason
        const rejectionReasonDiv = document.getElementById('rejectionReasonDiv');
        if (status === 'rejected' && product.rejectionReason) {
            document.getElementById('productRejectionReason').textContent = product.rejectionReason;
            rejectionReasonDiv.style.display = 'block';
        } else {
            rejectionReasonDiv.style.display = 'none';
        }
        
        // Product images/videos
        const imagesContainer = document.getElementById('productImages');
        const imageUrl = product.imageUrl || (product.imageUrls && product.imageUrls[0]);
        
        if (product.mediaType === 'video' && product.videoUrl) {
            // Show video player
            imagesContainer.innerHTML = `
                <div class="position-relative">
                    <video controls class="img-fluid rounded" style="max-height: 300px; object-fit: cover; width: 100%;">
                        <source src="${product.videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-danger">VIDEO</span>
                    </div>
                </div>
            `;
        } else if (imageUrl) {
            // Show image with metadata loading
            imagesContainer.innerHTML = `<img src="${imageUrl}" class="img-fluid rounded" alt="Product Image" id="productImagePreview" onload="loadImageMetadata('${imageUrl}')">`;
        } else {
            // Show placeholder
            imagesContainer.innerHTML = '<div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 200px;"><i class="fas fa-image fa-3x text-muted"></i></div>';
        }
        
        // Show/hide action buttons
        const actionsDiv = document.getElementById('productActions');
        if (status === 'pending') {
            actionsDiv.style.display = 'block';
        } else {
            actionsDiv.style.display = 'none';
        }
        
        new bootstrap.Modal(document.getElementById('productModal')).show();
    }

    // Preview product media (all photos/videos)
    function previewProductMedia(productId) {
        console.log('üöÄ previewProductMedia CALLED with productId:', productId);
        console.log('üöÄ productsData keys:', Object.keys(productsData));
        console.log('üöÄ productsData length:', Object.keys(productsData).length);
        
        const product = productsData[productId];
        if (!product) {
            console.error('‚ùå Product not found:', productId);
            console.error('‚ùå Available product IDs:', Object.keys(productsData));
            return;
        }

        console.log('‚úÖ Product found!');
        console.log('üîç Previewing media for product:', productId);
        console.log('üì¶ Product data:', product);
        console.log('üñºÔ∏è imageUrls:', product.imageUrls);
        console.log('üñºÔ∏è imageUrls type:', typeof product.imageUrls);
        console.log('üñºÔ∏è imageUrls isArray:', Array.isArray(product.imageUrls));
        if (product.imageUrls) {
            console.log('üñºÔ∏è imageUrls length:', product.imageUrls.length);
            console.log('üñºÔ∏è imageUrls content:', product.imageUrls);
        }
        console.log('üñºÔ∏è imageUrl:', product.imageUrl);
        console.log('üé• videoUrl:', product.videoUrl);
        console.log('üìπ mediaType:', product.mediaType);

        console.log('üîß Getting DOM elements...');
        const carouselInner = document.getElementById('mediaPreviewCarouselInner');
        const counter = document.getElementById('mediaPreviewCounter');
        
        if (!carouselInner) {
            console.error('‚ùå carouselInner element not found!');
            alert('Error: Carousel element not found. Please refresh the page.');
            return;
        }
        if (!counter) {
            console.warn('‚ö†Ô∏è counter element not found!');
        }
        
        console.log('‚úÖ DOM elements found');
        carouselInner.innerHTML = '';

        let mediaItems = [];
        let currentIndex = 0;
        
        console.log('üìä Starting media collection...');

        // Collect all media items - prioritize imageUrls array
        // First, add images from imageUrls array (this is the main source for multiple images)
        if (product.imageUrls) {
            // Handle both array and object cases
            let imageUrlsArray = [];
            if (Array.isArray(product.imageUrls)) {
                imageUrlsArray = product.imageUrls;
                console.log(`üìã imageUrls is an array with ${imageUrlsArray.length} items`);
            } else if (typeof product.imageUrls === 'object' && product.imageUrls !== null) {
                // Convert object to array if needed
                imageUrlsArray = Object.values(product.imageUrls);
                console.log(`üìã imageUrls is an object, converted to array with ${imageUrlsArray.length} items`);
            } else {
                console.warn(`‚ö†Ô∏è imageUrls is not an array or object:`, typeof product.imageUrls, product.imageUrls);
            }
            
            if (imageUrlsArray.length > 0) {
                console.log(`‚úÖ Processing ${imageUrlsArray.length} images from imageUrls array`);
                imageUrlsArray.forEach((url, index) => {
                    console.log(`  üì∏ Image ${index + 1}:`, typeof url, url ? url.substring(0, 60) + '...' : 'null/undefined');
                    if (url && typeof url === 'string' && url.trim() !== '') {
                        mediaItems.push({
                            type: 'image',
                            url: url.trim(),
                            index: index
                        });
                        console.log(`    ‚úÖ Added image ${index + 1} to mediaItems`);
                    } else {
                        console.warn(`    ‚ö†Ô∏è Skipped invalid image ${index + 1}:`, url);
                    }
                });
                console.log(`‚úÖ Total images added from imageUrls: ${mediaItems.length}`);
            } else {
                console.warn(`‚ö†Ô∏è imageUrls array is empty`);
            }
        } else {
            console.log(`‚ÑπÔ∏è No imageUrls field found in product`);
        }
        
        // If no images from imageUrls, try single imageUrl
        if (mediaItems.length === 0 && product.imageUrl) {
            console.log('‚ö†Ô∏è No images in imageUrls, using single imageUrl');
            mediaItems.push({
                type: 'image',
                url: product.imageUrl,
                index: 0
            });
        }

        // Add video if present
        if (product.mediaType === 'video' && product.videoUrl) {
            console.log('‚úÖ Found video');
            // Add video at the beginning
            mediaItems.unshift({
                type: 'video',
                url: product.videoUrl,
                thumbnail: product.videoThumbnailUrl || ''
            });
        }

        console.log(`üìä Total media items collected: ${mediaItems.length}`);

        if (mediaItems.length === 0) {
            carouselInner.innerHTML = `
                <div class="carousel-item active">
                    <div class="d-flex align-items-center justify-content-center" style="min-height: 400px;">
                        <div class="text-center">
                            <i class="fas fa-image fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No media available</p>
                        </div>
                    </div>
                </div>
            `;
            counter.textContent = '0 / 0';
        } else {
            console.log(`üé® Creating ${mediaItems.length} carousel items`);
            
            // Build all carousel items HTML first
            let carouselItemsHtml = '';
            mediaItems.forEach((item, index) => {
                const isActive = index === 0 ? 'active' : '';
                let mediaHtml = '';

                if (item.type === 'video') {
                    mediaHtml = `
                        <div class="carousel-item ${isActive}">
                            <div class="d-flex align-items-center justify-content-center" style="min-height: 500px; background: #000; padding: 20px;">
                                <video controls class="img-fluid" style="max-height: 600px; max-width: 100%; object-fit: contain; border-radius: 8px;">
                                    <source src="${item.url}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                        </div>
                    `;
                } else {
                    console.log(`  üì∏ Adding image ${index + 1}: ${item.url.substring(0, 50)}...`);
                    // Escape quotes in URL for HTML attribute
                    const escapedUrl = item.url.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                    mediaHtml = `
                        <div class="carousel-item ${isActive}">
                            <div class="d-flex align-items-center justify-content-center" style="min-height: 500px; background: #000; padding: 20px;">
                                <img src="${escapedUrl}" class="img-fluid" style="max-height: 600px; max-width: 100%; object-fit: contain; border-radius: 8px;" alt="Product Image ${index + 1}" onerror="console.error('Failed to load image ${index + 1}'); this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'400\'%3E%3Crect fill=\'%23ddd\' width=\'400\' height=\'400\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'20\' dy=\'10.5\' font-weight=\'bold\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\'%3EImage not found%3C/text%3E%3C/svg%3E';">
                            </div>
                        </div>
                    `;
                }

                carouselItemsHtml += mediaHtml;
            });

            // Set all carousel items at once
            carouselInner.innerHTML = carouselItemsHtml;
            console.log(`‚úÖ Created ${carouselInner.children.length} carousel items in DOM`);
            console.log(`üìä Carousel items HTML length: ${carouselItemsHtml.length} characters`);
            console.log(`üìä Expected ${mediaItems.length} items, got ${carouselInner.children.length} items`);
            
            // Verify all items are in DOM
            const allItems = carouselInner.querySelectorAll('.carousel-item');
            console.log(`üîç Found ${allItems.length} carousel-item elements in DOM`);
            
            if (allItems.length !== mediaItems.length) {
                console.error(`‚ùå CRITICAL: Mismatch! Expected ${mediaItems.length} items but found ${allItems.length} in DOM`);
                console.error(`‚ùå Carousel HTML:`, carouselItemsHtml.substring(0, 500));
            }
            
            allItems.forEach((item, idx) => {
                const mediaElements = item.querySelectorAll('img, video');
                console.log(`  Item ${idx + 1}: ${item.classList.contains('active') ? 'ACTIVE' : 'inactive'}, has ${mediaElements.length} media elements`);
                if (mediaElements.length > 0) {
                    const src = mediaElements[0].src || mediaElements[0].querySelector('source')?.src || 'no src';
                    console.log(`    URL: ${src.substring(0, 80)}...`);
                }
            });

            counter.textContent = `1 / ${mediaItems.length}`;

            // Show modal first, then initialize carousel
            const modalElement = document.getElementById('mediaPreviewModal');
            const modal = new bootstrap.Modal(modalElement);
            
            // Show modal first
            modal.show();
            
            // Initialize carousel after modal is fully shown
            modalElement.addEventListener('shown.bs.modal', function() {
                const carouselElement = document.getElementById('mediaPreviewCarousel');
                const carouselInnerElement = document.getElementById('mediaPreviewCarouselInner');
                
                // Verify items are in DOM
                const itemsInDOM = carouselInnerElement.querySelectorAll('.carousel-item');
                console.log(`üîç Verifying after modal shown: ${itemsInDOM.length} items in DOM, expected ${mediaItems.length}`);
                
                if (itemsInDOM.length !== mediaItems.length) {
                    console.error(`‚ùå Mismatch! Expected ${mediaItems.length} items but found ${itemsInDOM.length} in DOM`);
                    console.error(`‚ùå Re-setting carousel HTML...`);
                    // Re-set the HTML if there's a mismatch
                    carouselInnerElement.innerHTML = carouselItemsHtml;
                    
                    // Verify again
                    const itemsAfterReset = carouselInnerElement.querySelectorAll('.carousel-item');
                    console.log(`üîç After reset: ${itemsAfterReset.length} items in DOM`);
                }
                
                // Dispose existing carousel instance if any
                const existingCarousel = bootstrap.Carousel.getInstance(carouselElement);
                if (existingCarousel) {
                    existingCarousel.dispose();
                }
                
                // Initialize new carousel
                const carousel = new bootstrap.Carousel(carouselElement, {
                    interval: false, // Don't auto-advance
                    wrap: true // Allow wrapping from last to first
                });
                
                console.log('‚úÖ Bootstrap carousel initialized');
                const finalItems = carouselElement.querySelectorAll('.carousel-item');
                console.log(`üìä Final carousel has ${finalItems.length} items`);
                
                // Log all items for debugging
                finalItems.forEach((item, idx) => {
                    const isActive = item.classList.contains('active');
                    const hasMedia = item.querySelectorAll('img, video').length > 0;
                    const isVisible = item.offsetParent !== null;
                    const displayStyle = window.getComputedStyle(item).display;
                    console.log(`  üì∏ Carousel item ${idx + 1}: active=${isActive}, hasMedia=${hasMedia}, visible=${isVisible}, display=${displayStyle}`);
                    
                    // Check if image is loaded
                    const img = item.querySelector('img');
                    if (img) {
                        console.log(`    üñºÔ∏è Image src: ${img.src.substring(0, 80)}...`);
                        console.log(`    üñºÔ∏è Image complete: ${img.complete}, naturalWidth: ${img.naturalWidth}`);
                    }
                });
                
                // Debug info removed for production
                
                // Update counter on slide change
                carouselElement.addEventListener('slid.bs.carousel', function (event) {
                    const allCarouselItems = carouselElement.querySelectorAll('.carousel-item');
                    const activeIndex = Array.from(allCarouselItems).indexOf(event.relatedTarget);
                    document.getElementById('mediaPreviewCounter').textContent = `${activeIndex + 1} / ${mediaItems.length}`;
                    console.log(`üîÑ Carousel slid to index ${activeIndex + 1}`);
                });
            }, { once: true });
            
            console.log('‚úÖ Modal shown with', mediaItems.length, 'media items');
        }
    }

    // Approve product
    async function approveProduct(productId = null) {
        console.log('üîî DEBUG: approveProduct function called');
        const id = productId || selectedProductId;
        console.log('üîî DEBUG: Product ID:', id);
        console.log('üîî DEBUG: Selected product ID:', selectedProductId);
        if (!id) {
            console.log('üîî DEBUG: No product ID, returning');
            return;
        }
        
        try {
            console.log('Approving product:', id);
            
            // First, get the current product data to preserve it
            const getResponse = await fetch(`${FIREBASE_REST_BASE}/products/${id}?key=${FIREBASE_CONFIG.apiKey}`);
            if (!getResponse.ok) {
                throw new Error(`Failed to get product data: HTTP ${getResponse.status}`);
            }
            
            const productData = await getResponse.json();
            console.log('Current product data:', productData);
            
            // Update only the moderation fields while preserving all other data
            const updateData = {
                fields: {
                    ...productData.fields, // Preserve all existing fields
                    moderationStatus: { stringValue: 'approved' },
                    reviewedAt: { timestampValue: new Date().toISOString() },
                    reviewedBy: { stringValue: 'admin-rest-api' }
                }
            };
            
            console.log('Updating product with data:', updateData);
            
            const response = await fetch(`${FIREBASE_REST_BASE}/products/${id}?key=${FIREBASE_CONFIG.apiKey}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            console.log('Product approved successfully');
            console.log('üîî DEBUG: Starting notification creation process...');
            
            // Create notification directly for the seller
            const sellerId = productData.fields?.sellerId?.stringValue;
            console.log('üîî Product data fields:', productData.fields);
            console.log('üîî Extracted sellerId:', sellerId);
            console.log('üîî SellerId type:', typeof sellerId);
            console.log('üîî SellerId length:', sellerId?.length);
            
            if (sellerId) {
                console.log('üîî Creating notification directly for seller:', sellerId);
                try {
                    await createNotificationForSeller(productData, 'approved', null, id);
                    console.log('‚úÖ Notification created successfully for approval');
                } catch (notificationError) {
                    console.error('‚ùå Failed to create notification:', notificationError);
                    // Don't fail the approval if notification creation fails
                }
            } else {
                console.error('‚ùå No sellerId found in product data!');
                console.error('‚ùå Product data:', productData);
            }
            
            // Use real-time notification instead of regular alert
            if (realTimeNotifications) {
                showRealTimeNotification('Product approved successfully!', 'success');
            } else {
                showAlert('Product approved successfully!', 'success');
            }
            
            // Close modal and refresh data
            bootstrap.Modal.getInstance(document.getElementById('productModal'))?.hide();
            loadProducts();
            
        } catch (error) {
            console.error('Error approving product:', error);
            if (realTimeNotifications) {
                showRealTimeNotification(`Failed to approve product: ${error.message}`, 'danger');
            } else {
                showAlert(`Failed to approve product: ${error.message}`, 'error');
            }
        }
    }

    // Show reject modal
    function showRejectModal(productId = null) {
        selectedProductId = productId || selectedProductId;
        new bootstrap.Modal(document.getElementById('rejectProductModal')).show();
    }

    // Confirm reject product
    async function confirmRejectProduct() {
        if (!selectedProductId) return;
        
        const reason = document.getElementById('rejectionReason').value;
        const customReason = document.getElementById('customRejectionReason').value;
        
        if (!reason) {
            showAlert('Please select a rejection reason', 'error');
            return;
        }
        
        const finalReason = reason === 'Other' ? customReason : reason;
        if (!finalReason) {
            showAlert('Please provide a rejection reason', 'error');
            return;
        }
        
        try {
            console.log('Rejecting product:', selectedProductId, 'Reason:', finalReason);
            
            // First, get the current product data to preserve it
            const getResponse = await fetch(`${FIREBASE_REST_BASE}/products/${selectedProductId}?key=${FIREBASE_CONFIG.apiKey}`);
            if (!getResponse.ok) {
                throw new Error(`Failed to get product data: HTTP ${getResponse.status}`);
            }
            
            const productData = await getResponse.json();
            console.log('Current product data:', productData);
            
            // Update only the moderation fields while preserving all other data
            const updateData = {
                fields: {
                    ...productData.fields, // Preserve all existing fields
                    moderationStatus: { stringValue: 'rejected' },
                    rejectionReason: { stringValue: finalReason },
                    reviewedAt: { timestampValue: new Date().toISOString() },
                    reviewedBy: { stringValue: 'admin-rest-api' }
                }
            };
            
            console.log('Updating product with data:', updateData);
            
            const response = await fetch(`${FIREBASE_REST_BASE}/products/${selectedProductId}?key=${FIREBASE_CONFIG.apiKey}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            console.log('Product rejected successfully');
            
            // Create notification directly for the seller
            const sellerId = productData.fields?.sellerId?.stringValue;
            console.log('üîî Product data fields:', productData.fields);
            console.log('üîî Extracted sellerId:', sellerId);
            console.log('üîî SellerId type:', typeof sellerId);
            console.log('üîî SellerId length:', sellerId?.length);
            
            if (sellerId) {
                console.log('üîî Creating notification directly for seller:', sellerId);
                try {
                    await createNotificationForSeller(productData, 'rejected', finalReason, selectedProductId);
                    console.log('‚úÖ Notification created successfully for rejection');
                } catch (notificationError) {
                    console.error('‚ùå Failed to create notification:', notificationError);
                    // Don't fail the rejection if notification creation fails
                }
            } else {
                console.error('‚ùå No sellerId found in product data!');
                console.error('‚ùå Product data:', productData);
            }
            
            // Use real-time notification instead of regular alert
            if (realTimeNotifications) {
                showRealTimeNotification('Product rejected successfully!', 'warning');
            } else {
                showAlert('Product rejected successfully!', 'success');
            }
            
            // Close modals and refresh data
            bootstrap.Modal.getInstance(document.getElementById('rejectProductModal'))?.hide();
            bootstrap.Modal.getInstance(document.getElementById('productModal'))?.hide();
            loadProducts();
            
        } catch (error) {
            console.error('Error rejecting product:', error);
            if (realTimeNotifications) {
                showRealTimeNotification(`Failed to reject product: ${error.message}`, 'danger');
            } else {
                showAlert(`Failed to reject product: ${error.message}`, 'error');
            }
        }
    }

    // Show delete modal
    function showDeleteModal(productId = null) {
        selectedProductId = productId || selectedProductId;
        new bootstrap.Modal(document.getElementById('deleteProductModal')).show();
    }

    // Confirm delete product
    async function confirmDeleteProduct() {
        if (!selectedProductId) return;
        
        try {
            console.log('üóëÔ∏è Deleting product:', selectedProductId);
            
            // Get product data first to extract image URLs
            const getResponse = await fetch(`${FIREBASE_REST_BASE}/products/${selectedProductId}?key=${FIREBASE_CONFIG.apiKey}`);
            if (!getResponse.ok) {
                throw new Error(`Failed to get product data: HTTP ${getResponse.status}`);
            }
            
            const productData = await getResponse.json();
            console.log('Product data to delete:', productData);
            
            // Extract image URLs and video URL
            const imageUrls = [];
            const fields = productData.fields || {};
            
            // Get single imageUrl
            if (fields.imageUrl?.stringValue) {
                imageUrls.push(fields.imageUrl.stringValue);
            }
            
            // Get imageUrls array
            if (fields.imageUrls?.arrayValue?.values) {
                fields.imageUrls.arrayValue.values.forEach(item => {
                    if (item.stringValue) {
                        imageUrls.push(item.stringValue);
                    }
                });
            }
            
            // Get video URL
            if (fields.videoUrl?.stringValue) {
                imageUrls.push(fields.videoUrl.stringValue);
            }
            
            // Get video thumbnail
            if (fields.videoThumbnailUrl?.stringValue) {
                imageUrls.push(fields.videoThumbnailUrl.stringValue);
            }
            
            console.log('üì∏ Found images/videos to delete:', imageUrls);
            
            // Delete all comments associated with this product
            try {
                console.log('üóëÔ∏è Deleting comments for product:', selectedProductId);
                // Get all comments for this product using a query
                // Note: Firestore REST API doesn't support queries directly, so we'll need to get all comments and filter
                const commentsResponse = await fetch(`${FIREBASE_REST_BASE}/comments?key=${FIREBASE_CONFIG.apiKey}&pageSize=1000`);
                if (commentsResponse.ok) {
                    const commentsData = await commentsResponse.json();
                    if (commentsData.documents) {
                        const productComments = commentsData.documents.filter(doc => {
                            const productIdField = doc.fields?.productId?.stringValue;
                            return productIdField === selectedProductId;
                        });
                        
                        console.log(`üóëÔ∏è Found ${productComments.length} comments to delete`);
                        
                        // Delete each comment
                        const commentDeletePromises = productComments.map(async (commentDoc) => {
                            const commentId = commentDoc.name.split('/').pop();
                            try {
                                const deleteResponse = await fetch(`${FIREBASE_REST_BASE}/comments/${commentId}?key=${FIREBASE_CONFIG.apiKey}`, {
                                    method: 'DELETE'
                                });
                                if (deleteResponse.ok) {
                                    console.log('‚úÖ Deleted comment:', commentId);
                                } else {
                                    console.error('‚ùå Failed to delete comment:', commentId);
                                }
                            } catch (error) {
                                console.error('‚ùå Error deleting comment:', commentId, error);
                            }
                        });
                        
                        await Promise.allSettled(commentDeletePromises);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error deleting comments:', error);
                // Continue with product deletion even if comment deletion fails
            }
            
            // Delete the product document from Firestore
            const deleteResponse = await fetch(`${FIREBASE_REST_BASE}/products/${selectedProductId}?key=${FIREBASE_CONFIG.apiKey}`, {
                method: 'DELETE'
            });
            
            if (!deleteResponse.ok) {
                throw new Error(`HTTP ${deleteResponse.status}: ${deleteResponse.statusText}`);
            }
            
            console.log('‚úÖ Product deleted successfully from database');
            
            // Note: Firebase Storage files will need to be deleted separately
            // For now, the product is deleted from Firestore. Storage cleanup can be done via Cloud Functions
            // or manually. The image URLs are logged above for reference.
            if (imageUrls.length > 0) {
                console.log('‚ö†Ô∏è Note: Product images/videos in Storage need to be deleted separately:', imageUrls);
            }
            
            // Create notification for seller if sellerId exists
            const sellerId = fields.sellerId?.stringValue;
            if (sellerId) {
                try {
                    // Create a notification that product was deleted
                    const notificationData = {
                        fields: {
                            userId: { stringValue: sellerId },
                            type: { stringValue: 'product_status' },
                            title: { stringValue: 'Product Deleted' },
                            message: { stringValue: `Your product "${fields.title?.stringValue || 'Product'}" has been deleted by an administrator.` },
                            productId: { stringValue: selectedProductId },
                            isRead: { booleanValue: false },
                            createdAt: { timestampValue: new Date().toISOString() }
                        }
                    };
                    
                    await fetch(`${FIREBASE_REST_BASE}/notifications?key=${FIREBASE_CONFIG.apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(notificationData)
                    });
                    console.log('‚úÖ Notification created for product deletion');
                } catch (notificationError) {
                    console.error('‚ùå Failed to create notification:', notificationError);
                    // Don't fail the deletion if notification creation fails
                }
            }
            
            // Show success message
            if (realTimeNotifications) {
                showRealTimeNotification('Product deleted successfully!', 'success');
            } else {
                showAlert('Product deleted successfully!', 'success');
            }
            
            // Close modals and refresh data
            bootstrap.Modal.getInstance(document.getElementById('deleteProductModal'))?.hide();
            bootstrap.Modal.getInstance(document.getElementById('productModal'))?.hide();
            loadProducts();
            
        } catch (error) {
            console.error('‚ùå Error deleting product:', error);
            if (realTimeNotifications) {
                showRealTimeNotification(`Failed to delete product: ${error.message}`, 'danger');
            } else {
                showAlert(`Failed to delete product: ${error.message}`, 'error');
            }
        }
    }

    // Test notification function
    async function testNotification() {
        console.log('üîî TEST: Testing notification creation...');
        
        if (!selectedProductId) {
            console.log('üîî TEST: No product selected');
            alert('Please select a product first');
            return;
        }
        
        try {
            // Get product data
            const getResponse = await fetch(`${FIREBASE_REST_BASE}/products/${selectedProductId}?key=${FIREBASE_CONFIG.apiKey}`);
            if (!getResponse.ok) {
                throw new Error(`Failed to get product data: HTTP ${getResponse.status}`);
            }
            
            const productData = await getResponse.json();
            console.log('üîî TEST: Product data:', productData);
            
            // Test notification creation
            await createNotificationForSeller(productData, 'approved', null, selectedProductId);
            console.log('üîî TEST: Notification creation completed');
            alert('Test notification created! Check console for details.');
            
        } catch (error) {
            console.error('üîî TEST: Error:', error);
            alert('Test failed: ' + error.message);
        }
    }

    // Create notification for seller
    async function createNotificationForSeller(productData, status, rejectionReason = null, productId = null) {
        try {
            console.log('üîî Creating notification for seller:', status);
            console.log('üîî Product data:', productData);
            console.log('üîî Selected product ID:', selectedProductId);
            console.log('üîî Passed product ID:', productId);
            
            // Extract seller ID and product title from product data
            const sellerId = productData.fields?.sellerId?.stringValue || '';
            const productTitle = productData.fields?.title?.stringValue || 'Untitled Product';
            const finalProductId = productId || selectedProductId;
            
            console.log('üîî Seller ID:', sellerId);
            console.log('üîî Product Title:', productTitle);
            console.log('üîî Final Product ID:', finalProductId);
            
            if (!sellerId) {
                console.warn('No seller ID found for product:', finalProductId);
                return;
            }
            
            if (!finalProductId) {
                console.warn('No product ID available for notification');
                return;
            }
            
            // Create notification data
            const notificationId = `notification_${Date.now()}_${finalProductId}`;
            const notification = {
                id: notificationId,
                userId: sellerId,
                productId: finalProductId,
                productTitle: productTitle,
                type: 'product_status',
                status: status,
                rejectionReason: rejectionReason,
                isRead: false,
                createdAt: new Date().toISOString(),
                title: getNotificationTitle(status),
                message: getNotificationMessage(status, productTitle, rejectionReason)
            };
            
            // Save to Firestore
            console.log('üîî Creating notification with data:', notification);
            console.log('üîî Notification ID:', notificationId);
            console.log('üîî API URL:', `${FIREBASE_REST_BASE}/notifications/${notificationId}?key=${FIREBASE_CONFIG.apiKey}`);
            
            const response = await fetch(`${FIREBASE_REST_BASE}/notifications/${notificationId}?key=${FIREBASE_CONFIG.apiKey}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fields: {
                        id: { stringValue: notification.id },
                        userId: { stringValue: notification.userId },
                        productId: { stringValue: notification.productId },
                        productTitle: { stringValue: notification.productTitle },
                        type: { stringValue: notification.type },
                        status: { stringValue: notification.status },
                        rejectionReason: { stringValue: notification.rejectionReason || '' },
                        isRead: { booleanValue: notification.isRead },
                        createdAt: { timestampValue: notification.createdAt },
                        title: { stringValue: notification.title },
                        message: { stringValue: notification.message }
                    }
                })
            });
            
            console.log('üîî Notification creation response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('üîî Failed to create notification:', errorText);
                throw new Error(`Failed to create notification: HTTP ${response.status} - ${errorText}`);
            }
            
            console.log('‚úÖ Notification created successfully:', notificationId);
            
        } catch (error) {
            console.error('Error creating notification:', error);
        }
    }
    
    // Get notification title based on status
    function getNotificationTitle(status) {
        switch (status) {
            case 'pending':
                return 'Product Under Review ‚è≥';
            case 'approved':
                return 'Product Approved! üéâ';
            case 'rejected':
                return 'Product Rejected ‚ùå';
            default:
                return 'Product Status Update';
        }
    }
    
    // Get notification message based on status
    function getNotificationMessage(status, productTitle, rejectionReason) {
        switch (status) {
            case 'pending':
                return `Your product "${productTitle}" is under review by our team.`;
            case 'approved':
                return `Great news! Your product "${productTitle}" has been approved and is now live!`;
            case 'rejected':
                const reason = rejectionReason ? `\n\nReason: ${rejectionReason}` : '';
                return `Your product "${productTitle}" has been rejected.${reason}`;
            default:
                return `Your product "${productTitle}" status has been updated.`;
        }
    }

    // Filter products
    function filterProducts(searchTerm) {
        const filteredProducts = {};
        
        Object.entries(productsData).forEach(([productId, product]) => {
            const searchableText = `
                ${product.title || ''}
                ${product.description || ''}
                ${product.category || ''}
                ${product.sellerName || ''}
            `.toLowerCase();
            
            if (searchableText.includes(searchTerm.toLowerCase())) {
                filteredProducts[productId] = product;
            }
        });
        
        displayProducts(filteredProducts);
    }

    // Filter products by status
    function filterProductsByStatus(status) {
        if (!status) {
            displayProducts(productsData);
            return;
        }
        
        const filteredProducts = {};
        Object.entries(productsData).forEach(([productId, product]) => {
            if ((product.moderationStatus || 'pending') === status) {
                filteredProducts[productId] = product;
            }
        });
        
        displayProducts(filteredProducts);
    }

    // Filter products by category
    function filterProductsByCategory(category) {
        if (!category) {
            displayProducts(productsData);
            return;
        }
        
        const filteredProducts = {};
        Object.entries(productsData).forEach(([productId, product]) => {
            if (product.category === category) {
                filteredProducts[productId] = product;
            }
        });
        
        displayProducts(filteredProducts);
    }

    // Load and display image metadata from Firebase Storage
    // Note: We skip fetching the image blob to avoid CORS issues
    async function loadImageMetadata(imageUrl) {
        const metadataContainer = document.getElementById('imageMetadata');
        if (!metadataContainer) return;

        try {
            console.log('üì∏ Loading metadata for image:', imageUrl);
            // Skip blob fetching to avoid CORS issues
            // Go directly to Firebase Storage metadata API
            await extractStorageMetadata(imageUrl, metadataContainer);
        } catch (error) {
            console.error('‚ùå Error loading image metadata:', error);
            if (metadataContainer) {
                metadataContainer.innerHTML = '<span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Could not load metadata</span>';
            }
        }
    }

    // Extract metadata from Firebase Storage
    async function extractStorageMetadata(imageUrl, container) {
        try {
            console.log('üîç Attempting to extract metadata from:', imageUrl);
            
            // First, try to get metadata from Firestore (product data) as primary source
            // This avoids CORS issues completely since Firestore allows cross-origin requests
            const product = productsData[selectedProductId];
            console.log('üîç Checking product data for metadata. Product:', product);
            console.log('üîç Product keys:', product ? Object.keys(product) : 'No product');
            
            if (product) {
                // Check for imageMetadata field in product
                console.log('üîç Checking imageMetadata field:', product.imageMetadata);
                if (product.imageMetadata && typeof product.imageMetadata === 'object') {
                    console.log('‚úÖ Found metadata in product data:', product.imageMetadata);
                    console.log('üìä Metadata keys:', Object.keys(product.imageMetadata));
                    displayMetadata(product.imageMetadata, container);
                    return;
                }
                
                // For products without imageMetadata, try to construct from available data
                if (product.sellerUsername || product.createdAt) {
                    console.log('üìä Constructing metadata from product data');
                    const constructedMetadata = {
                        username: product.sellerUsername || product.sellerName || 'Unknown',
                        userId: product.sellerId || '',
                        productId: product.id || selectedProductId || '',
                        uploadDate: product.createdAt || new Date().toISOString(),
                        deviceInfo: 'Unknown Device',
                        appName: 'MarketSafe',
                        appVersion: '1.0.3',
                    };
                    console.log('üìä Constructed metadata:', constructedMetadata);
                    displayMetadata(constructedMetadata, container);
                    return;
                }
            }
            
            // If no product data available, try to fetch from Firestore directly
            // This still avoids CORS since we're using Firestore REST API
            try {
                console.log('üì° Attempting to fetch product metadata from Firestore...');
                // Use FIREBASE_REST_BASE which already includes the correct database ID (marketsafe)
                const firestoreUrl = `${FIREBASE_REST_BASE}/products/${selectedProductId}?key=${FIREBASE_CONFIG.apiKey}`;
                console.log('üì° Fetching from Firestore:', firestoreUrl);
                const response = await fetch(firestoreUrl);
                console.log('üìä Firestore response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä Firestore response data:', data);
                    
                    if (data.fields && data.fields.imageMetadata) {
                        // Firestore returns fields in a specific format
                        const metadataField = data.fields.imageMetadata.mapValue?.fields || {};
                        const metadata = {};
                        for (const [key, value] of Object.entries(metadataField)) {
                            if (value.stringValue !== undefined) {
                                metadata[key] = value.stringValue;
                            } else if (value.integerValue !== undefined) {
                                metadata[key] = parseInt(value.integerValue);
                            } else if (value.doubleValue !== undefined) {
                                metadata[key] = parseFloat(value.doubleValue);
                            }
                        }
                        if (Object.keys(metadata).length > 0) {
                            console.log('‚úÖ Found metadata in Firestore:', metadata);
                            displayMetadata(metadata, container);
                            return;
                        }
                    } else {
                        console.log('‚ö†Ô∏è No imageMetadata field in Firestore document');
                        console.log('üìä Available fields:', Object.keys(data.fields || {}));
                    }
                } else {
                    const errorText = await response.text();
                    console.log('‚ö†Ô∏è Firestore fetch failed:', response.status, errorText);
                }
            } catch (e) {
                console.error('‚ùå Error fetching from Firestore:', e);
            }
            
            // Skip Firebase Storage API call if opening from file:// protocol
            // (CORS will block it anyway)
            // Firestore approach above should have already worked
            console.log('‚ö†Ô∏è Metadata not found in Firestore, falling back to product data');
            displayProductMetadata(container);
        } catch (error) {
            console.error('‚ùå Error extracting storage metadata:', error);
            displayProductMetadata(container);
        }
    }

    // Display metadata in the container
    function displayMetadata(metadata, container) {
        if (!metadata || Object.keys(metadata).length === 0) {
            console.log('‚ö†Ô∏è Empty metadata, using fallback');
            displayProductMetadata(container);
            return;
        }

        console.log('üìä Displaying metadata:', metadata);

        // Remove text-muted class from container to ensure text is visible
        container.classList.remove('text-muted');
        container.classList.add('text-dark');
        
        let html = '<div class="metadata-list" style="color: #333;">';
        
        if (metadata.username) {
            html += `<div class="mb-1"><strong style="color: #dc3545;">Username:</strong> <span style="color: #333; margin-left: 8px;">${escapeHtml(metadata.username)}</span></div>`;
        }
        if (metadata.uploadDate) {
            try {
                const date = new Date(metadata.uploadDate);
                html += `<div class="mb-1"><strong style="color: #dc3545;">Upload Date:</strong> <span style="color: #333; margin-left: 8px;">${date.toLocaleString()}</span></div>`;
            } catch (e) {
                html += `<div class="mb-1"><strong style="color: #dc3545;">Upload Date:</strong> <span style="color: #333; margin-left: 8px;">${escapeHtml(metadata.uploadDate)}</span></div>`;
            }
        } else if (metadata.uploadedAt) {
            try {
                const date = new Date(metadata.uploadedAt);
                html += `<div class="mb-1"><strong style="color: #dc3545;">Upload Date:</strong> <span style="color: #333; margin-left: 8px;">${date.toLocaleString()}</span></div>`;
            } catch (e) {
                html += `<div class="mb-1"><strong style="color: #dc3545;">Upload Date:</strong> <span style="color: #333; margin-left: 8px;">${escapeHtml(metadata.uploadedAt)}</span></div>`;
            }
        }
        if (metadata.uniqueId) {
            html += `<div class="mb-1"><strong style="color: #dc3545;">Unique ID:</strong> <span style="color: #333; margin-left: 8px; font-family: monospace; font-size: 0.9em;">${escapeHtml(metadata.uniqueId)}</span></div>`;
        }
        if (metadata.productId) {
            html += `<div class="mb-1"><strong style="color: #dc3545;">Product ID:</strong> <span style="color: #333; margin-left: 8px; font-family: monospace; font-size: 0.9em;">${escapeHtml(metadata.productId)}</span></div>`;
        }
        if (metadata.deviceInfo) {
            html += `<div class="mb-1"><strong style="color: #dc3545;">Device:</strong> <span style="color: #333; margin-left: 8px;">${escapeHtml(metadata.deviceInfo)}</span></div>`;
        }
        if (metadata.userId) {
            html += `<div class="mb-1"><strong style="color: #dc3545;">User ID:</strong> <span style="color: #333; margin-left: 8px; font-family: monospace; font-size: 0.9em;">${escapeHtml(metadata.userId)}</span></div>`;
        }
        if (metadata.appName) {
            html += `<div class="mb-1"><strong style="color: #dc3545;">App:</strong> <span style="color: #333; margin-left: 8px;">${escapeHtml(metadata.appName)}</span></div>`;
        }
        if (metadata.appVersion) {
            html += `<div class="mb-1"><strong style="color: #dc3545;">Version:</strong> <span style="color: #333; margin-left: 8px;">${escapeHtml(metadata.appVersion)}</span></div>`;
        }
        if (metadata.watermarked === 'true' || metadata.watermarked === true) {
            html += `<div class="mb-1"><span class="badge bg-success">Watermarked</span></div>`;
        }
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Display product metadata as fallback
    function displayProductMetadata(container) {
        // Remove text-muted class to ensure text is visible
        container.classList.remove('text-muted');
        container.classList.add('text-dark');
        
        const product = productsData[selectedProductId];
        if (!product) {
            container.innerHTML = '<span style="color: #6c757d;">No metadata available</span>';
            return;
        }

        let html = '<div class="metadata-list" style="color: #333;">';
        html += `<div class="mb-1"><strong style="color: #dc3545;">Seller:</strong> <span style="color: #333; margin-left: 8px;">${escapeHtml(product.sellerName || 'Unknown')}</span></div>`;
        if (product.createdAt) {
            try {
                const date = new Date(product.createdAt);
                html += `<div class="mb-1"><strong style="color: #dc3545;">Created:</strong> <span style="color: #333; margin-left: 8px;">${date.toLocaleString()}</span></div>`;
            } catch (e) {
                html += `<div class="mb-1"><strong style="color: #dc3545;">Created:</strong> <span style="color: #333; margin-left: 8px;">${escapeHtml(product.createdAt)}</span></div>`;
            }
        }
        html += `<div class="mb-1"><strong style="color: #dc3545;">Product ID:</strong> <span style="color: #333; margin-left: 8px; font-family: monospace; font-size: 0.9em;">${escapeHtml(selectedProductId)}</span></div>`;
        html += '</div>';
        container.innerHTML = html;
    }

    // ==================== ADMIN MANAGEMENT FUNCTIONS ====================
    
    function addAdminManagementTab() {
        console.log('üìã Adding Admin Management tab...');
        const tabItem = document.getElementById('adminManagementTabItem');
        if (tabItem) {
            tabItem.style.display = 'block';
            console.log('‚úÖ Admin Management tab is now visible');
        } else {
            console.error('‚ùå Admin Management tab item not found in DOM!');
            console.error('‚ùå Looking for element with ID: adminManagementTabItem');
        }
        loadAdmins();
    }

    async function loadAdmins() {
        try {
            console.log('üìã Loading admins...');
            const response = await fetch(`${FIREBASE_REST_BASE}/adminUsers?key=${FIREBASE_CONFIG.apiKey}`);
            console.log('üìä Load admins response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('üìã Admins data:', data);
                const admins = [];
                
                if (data.documents) {
                    for (const doc of data.documents) {
                        const docId = doc.name.split('/').pop();
                        const fields = doc.fields;
                        const role = fields.role?.stringValue || 'admin';
                        
                        // Skip manager - only show regular admins in the list
                        if (role === 'manager') {
                            console.log('‚è≠Ô∏è Skipping manager from admin list:', docId);
                            continue;
                        }
                        
                        // Debug: Log each admin document
                        console.log('üìã Processing admin document:', docId, fields);
                        
                        admins.push({
                            id: docId,
                            email: fields.email?.stringValue || 'No email',
                            name: fields.name?.stringValue || 'No name',
                            role: role,
                            lastLoginAt: fields.lastLoginAt?.timestampValue || null
                        });
                    }
                }
                
                console.log('‚úÖ Loaded', admins.length, 'admins');
                displayAdmins(admins);
            } else {
                const errorText = await response.text();
                console.error('‚ùå Error loading admins:', response.status, errorText);
                document.getElementById('adminsTableBody').innerHTML = 
                    `<tr><td colspan="5" class="text-center text-danger">Error loading admins: ${response.status}</td></tr>`;
            }
        } catch (error) {
            console.error('‚ùå Error loading admins:', error);
            document.getElementById('adminsTableBody').innerHTML = 
                `<tr><td colspan="5" class="text-center text-danger">Error loading admins: ${error.message}</td></tr>`;
        }
    }

    function displayAdmins(admins) {
        const tbody = document.getElementById('adminsTableBody');
        if (admins.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No admins found</td></tr>';
            return;
        }

        tbody.innerHTML = admins.map(admin => {
            const lastLogin = admin.lastLoginAt ? 
                new Date(admin.lastLoginAt).toLocaleString() : 'Never';
            const roleBadge = admin.role === 'manager' ? 
                '<span class="badge bg-danger">Manager</span>' : 
                '<span class="badge bg-secondary">Admin</span>';
            
            // Show placeholder if name/email is missing
            const displayName = admin.name && admin.name !== 'No name' && admin.name.trim() !== '' ? 
                escapeHtml(admin.name) : 
                '<span class="text-muted fst-italic">(No name set)</span>';
            const displayEmail = admin.email && admin.email !== 'No email' && admin.email.trim() !== '' ? 
                escapeHtml(admin.email) : 
                '<span class="text-muted fst-italic">(No email set)</span>';
            
            return `
                <tr>
                    <td>${displayName}</td>
                    <td>${displayEmail}</td>
                    <td>${roleBadge}</td>
                    <td>${lastLogin}</td>
                    <td>
                        ${admin.role !== 'manager' && currentUserRole === 'manager' ? 
                            `<button class="btn btn-sm btn-danger" onclick="deleteAdmin('${admin.id}')">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>` : 
                            '<span class="text-muted">-</span>'}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function showCreateAdminModal() {
        const modalHtml = `
            <div class="modal fade" id="createAdminModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color: var(--pure-black);">
                            <h5 class="modal-title text-white">
                                <i class="fas fa-user-plus me-2"></i>Create New Admin
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="createAdminError" class="alert alert-danger" style="display: none;"></div>
                            <form id="createAdminForm">
                                <div class="mb-3">
                                    <label for="adminName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="adminName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="adminEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="adminEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="adminPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="adminPassword" required minlength="6">
                                    <small class="form-text text-muted">Minimum 6 characters</small>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="createAdmin()">
                                <i class="fas fa-save me-2"></i>Create Admin
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existing = document.getElementById('createAdminModal');
        if (existing) existing.remove();
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('createAdminModal'));
        modal.show();
        
        // Handle form submit
        document.getElementById('createAdminForm').addEventListener('submit', (e) => {
            e.preventDefault();
            createAdmin();
        });
    }

    async function createAdmin() {
        const name = document.getElementById('adminName').value.trim();
        const email = document.getElementById('adminEmail').value.trim();
        const password = document.getElementById('adminPassword').value;

        const errorDiv = document.getElementById('createAdminError');
        errorDiv.style.display = 'none';

        if (!name || !email || !password) {
            errorDiv.textContent = 'Please fill in all fields';
            errorDiv.style.display = 'block';
            return;
        }

        if (password.length < 6) {
            errorDiv.textContent = 'Password must be at least 6 characters';
            errorDiv.style.display = 'block';
            return;
        }

        try {
            console.log('üë§ Creating Firebase Auth user for:', email);
            
            // Check if currentUser is set
            if (!currentUser || !currentUser.uid) {
                throw new Error('You must be logged in to create admins.');
            }
            
            // Set flag to prevent auth state change handler from running
            isCreatingAdmin = true;
            console.log('üö© Set isCreatingAdmin flag to true');
            
            // Store manager's user ID, email, and auth token before creating admin
            const managerUserId = currentUser.uid;
            const managerEmail = currentUser.email;
            const managerAuthToken = await window.firebaseAuth.currentUser?.getIdToken();
            console.log('üë§ Storing manager info before admin creation:', managerUserId, managerEmail);
            
            // Disable button during creation
            const createButton = document.querySelector('#createAdminModal .btn-primary');
            if (createButton) {
                createButton.disabled = true;
                createButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';
            }
            
            // Create Firebase Auth user
            // NOTE: This will automatically sign in as the new user!
            const userCredential = await window.createUserWithEmailAndPassword(
                window.firebaseAuth, 
                email, 
                password
            );
            const userId = userCredential.user.uid;
            console.log('‚úÖ Firebase Auth user created with ID:', userId);
            console.log('‚ö†Ô∏è Firebase auto-signed in as new user (this is expected)');

            // Verify current user is a manager before creating admin
            if (currentUserRole !== 'manager') {
                throw new Error('Only managers can create admin accounts.');
            }
            
            // Add admin to Firestore
            const adminData = {
                fields: {
                    email: { stringValue: email },
                    name: { stringValue: name },
                    role: { stringValue: 'admin' }, // Regular admin, not manager
                    permissions: {
                        mapValue: {
                            fields: {
                                canApproveUsers: { booleanValue: true },
                                canRejectUsers: { booleanValue: true },
                                canViewUserData: { booleanValue: true },
                                canDeleteUsers: { booleanValue: false },
                                canCreateAdmins: { booleanValue: false } // Admins cannot create other admins
                            }
                        }
                    },
                    createdAt: { timestampValue: new Date().toISOString() },
                    createdBy: { stringValue: currentUser.uid },
                    createdByName: { stringValue: currentUser.name || 'Manager' }
                }
            };

            console.log('üìù Creating admin in Firestore with data:', adminData);
            console.log('üìù Firestore URL:', `${FIREBASE_REST_BASE}/adminUsers/${userId}?key=${FIREBASE_CONFIG.apiKey}`);
            
            // For Firestore REST API v1, to create a document with specific ID:
            // Use PATCH without updateMask (updateMask is only for updates, not creates)
            // PATCH will create the document if it doesn't exist
            const response = await fetch(`${FIREBASE_REST_BASE}/adminUsers/${userId}?key=${FIREBASE_CONFIG.apiKey}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(adminData)
            });

            console.log('üìä Create admin response status:', response.status);
            
            if (response.ok) {
                const responseData = await response.json();
                console.log('‚úÖ Admin created successfully in Firestore:', responseData);
                
                // Clear the form
                document.getElementById('adminName').value = '';
                document.getElementById('adminEmail').value = '';
                document.getElementById('adminPassword').value = '';
                
                // IMPORTANT: Firebase auto-signed in as the new admin user
                // We need to sign out the new user and restore manager session
                console.log('üîÑ Signing out new admin user (Firebase auto-signed in as them)...');
                
                // Keep flag set to prevent auth state change handler from running during sign out
                
                await window.firebaseAuth.signOut();
                
                // Wait a moment for sign out to complete
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('createAdminModal')).hide();
                
                // Reload admins list
                loadAdmins();
                
                // Show success message
                alert('‚úÖ Admin account created successfully!\n\nThe new admin can now log in and will have access to:\n- User Management\n- Product Moderation\n\n‚ö†Ô∏è You will need to log in again as manager.');
                
                // Reset the flag AFTER showing the message and waiting a bit
                // This allows the user to see the success message before redirect
                setTimeout(() => {
                    isCreatingAdmin = false;
                    console.log('üö© Reset isCreatingAdmin flag to false - will redirect to login');
                    // The auth state change handler will detect no user and redirect to login
                }, 2000);
            } else {
                const errorText = await response.text();
                console.error('‚ùå Failed to create admin:', response.status, errorText);
                console.error('‚ùå Full error details:', {
                    status: response.status,
                    statusText: response.statusText,
                    errorText: errorText,
                    url: `${FIREBASE_REST_BASE}/adminUsers/${userId}?key=${FIREBASE_CONFIG.apiKey}`,
                    requestBody: JSON.stringify(adminData, null, 2)
                });
                
                // Try to parse error for better message
                let errorMessage = `Failed to create admin in Firestore: ${response.status}`;
                try {
                    const errorJson = JSON.parse(errorText);
                    if (errorJson.error && errorJson.error.message) {
                        errorMessage = errorJson.error.message;
                        console.error('‚ùå Parsed error message:', errorMessage);
                    }
                } catch (e) {
                    errorMessage = `${errorMessage} - ${errorText}`;
                }
                
                throw new Error(errorMessage);
            }
        } catch (error) {
            // Reset flag on error
            isCreatingAdmin = false;
            console.log('üö© Reset isCreatingAdmin flag to false (error occurred)');
            
            console.error('‚ùå Error creating admin:', error);
            let errorMessage = 'Failed to create admin. Please try again.';
            
            // Handle Firebase Auth errors
            if (error.code === 'auth/email-already-in-use') {
                errorMessage = '‚ùå This email is already registered in Firebase Authentication. Please use a different email address.';
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = '‚ùå Invalid email address. Please enter a valid email.';
            } else if (error.code === 'auth/weak-password') {
                errorMessage = '‚ùå Password is too weak. Please use a stronger password (at least 6 characters).';
            } else if (error.code === 'auth/operation-not-allowed') {
                errorMessage = '‚ùå Email/password accounts are not enabled. Please contact the administrator.';
            } else if (error.code === 'auth/network-request-failed') {
                errorMessage = '‚ùå Network error. Please check your internet connection and try again.';
            } else if (error.message) {
                // Check if it's a Firebase error
                if (error.message.includes('email-already-in-use') || error.message.includes('EMAIL_EXISTS')) {
                    errorMessage = '‚ùå This email is already registered. Please use a different email address.';
                } else {
                    errorMessage = `‚ùå ${error.message}`;
                }
            }
            
            errorDiv.textContent = errorMessage;
            errorDiv.style.display = 'block';
            
            // Re-enable the button
            const loginButton = document.querySelector('#createAdminModal .btn-primary');
            if (loginButton) {
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-save me-2"></i>Create Admin';
            }
        }
    }

    async function deleteAdmin(adminId) {
        if (!confirm('Are you sure you want to delete this admin? This action cannot be undone.')) {
            return;
        }

        try {
            console.log('üóëÔ∏è Deleting admin:', adminId);
            const response = await fetch(`${FIREBASE_REST_BASE}/adminUsers/${adminId}?key=${FIREBASE_CONFIG.apiKey}`, {
                method: 'DELETE'
            });

            console.log('üìä Delete admin response status:', response.status);

            if (response.ok) {
                console.log('‚úÖ Admin deleted successfully');
                alert('Admin deleted successfully!');
                loadAdmins();
            } else {
                const errorText = await response.text();
                console.error('‚ùå Failed to delete admin:', response.status, errorText);
                throw new Error(`Failed to delete admin: ${response.status} - ${errorText}`);
            }
        } catch (error) {
            console.error('‚ùå Error deleting admin:', error);
            alert(`Failed to delete admin: ${error.message || 'Please try again.'}`);
        }
    }

    // APK Download Function
    function downloadAPK(event) {
        event.preventDefault();
        
        // Direct download URL - serving from web hosting (marketsafe.apk in web folder)
        // This file is served directly from Firebase Hosting, no Storage needed
        const downloadUrl = 'https://marketsafe-e57cf.web.app/marketsafe.apk';
        
        // Use fetch to download the file
        fetch(downloadUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                // Create a blob URL and trigger download
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'MarketSafe-v1.0.4.apk';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                }, 100);
                
                console.log('‚úÖ APK download started');
            })
            .catch(error => {
                console.error('‚ùå Error downloading APK:', error);
                console.log('üí° Tip: If you see a 403 error, upload the APK first using: node upload_apk.js');
                // Fallback to direct link
                window.open(downloadUrl, '_blank');
            });
    }

    // Reports Functions
    let reportsData = {};

    async function loadReports() {
        try {
            const tbody = document.getElementById('reportsTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>';
            }

            console.log('üìã Loading reports from Firestore via REST API...');
            
            // Use REST API like the rest of the admin panel
            const response = await fetch(`${FIREBASE_REST_BASE}/reports?key=${FIREBASE_CONFIG.apiKey}`);
            
            if (!response.ok) {
                if (response.status === 404) {
                    // Collection doesn't exist yet or is empty
                    console.log('‚ÑπÔ∏è Reports collection not found or empty');
                    reportsData = {};
                    displayReports();
                    updatePendingReportsBadge();
                    return;
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            reportsData = {};
            const reportsArray = [];

            // Parse REST API response
            if (data.documents && Array.isArray(data.documents)) {
                data.documents.forEach(doc => {
                    const docId = doc.name.split('/').pop();
                    const fields = doc.fields || {};
                    
                    const report = {
                        id: docId,
                        reporterId: convertFirestoreValue(fields.reporterId),
                        reporterUsername: convertFirestoreValue(fields.reporterUsername) || 'Unknown',
                        reporterEmail: convertFirestoreValue(fields.reporterEmail) || '',
                        reportedUserId: convertFirestoreValue(fields.reportedUserId),
                        reportedUsername: convertFirestoreValue(fields.reportedUsername) || 'Unknown',
                        reportedEmail: convertFirestoreValue(fields.reportedEmail) || '',
                        reason: convertFirestoreValue(fields.reason) || '',
                        customReason: convertFirestoreValue(fields.customReason) || '',
                        status: convertFirestoreValue(fields.status) || 'pending',
                        createdAt: convertFirestoreValue(fields.createdAt),
                        reviewedAt: convertFirestoreValue(fields.reviewedAt),
                        reviewedBy: convertFirestoreValue(fields.reviewedBy),
                        adminNotes: convertFirestoreValue(fields.adminNotes) || ''
                    };
                    
                    reportsArray.push(report);
                });
            }

            // Filter by status if needed
            const statusFilter = document.getElementById('reportStatusFilter')?.value;
            const filteredReports = statusFilter 
                ? reportsArray.filter(r => r.status === statusFilter)
                : reportsArray;

            // Sort by createdAt (descending)
            filteredReports.sort((a, b) => {
                const aTime = a.createdAt ? new Date(a.createdAt) : new Date(0);
                const bTime = b.createdAt ? new Date(b.createdAt) : new Date(0);
                return bTime - aTime; // Descending order
            });

            // Convert to object
            filteredReports.forEach(report => {
                reportsData[report.id] = report;
            });

            console.log(`‚úÖ Loaded ${Object.keys(reportsData).length} reports`);
            displayReports();
            updatePendingReportsBadge();
        } catch (error) {
            console.error('‚ùå Error loading reports:', error);
            const tbody = document.getElementById('reportsTableBody');
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error loading reports: ${error.message}
                    <br><button class="btn btn-sm btn-primary mt-2" onclick="loadReports()">Retry</button>
                </td></tr>`;
            }
            showError('Failed to load reports: ' + error.message);
        }
    }

    function displayReports() {
        const tbody = document.getElementById('reportsTableBody');
        if (!tbody) return;

        if (Object.keys(reportsData).length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No reports found</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        Object.values(reportsData).forEach(report => {
            const reasonLabels = {
                'inappropriate_content': 'Inappropriate Content',
                'spam_scam': 'Spam or Scam',
                'harassment': 'Harassment or Bullying',
                'fake_account': 'Fake Account',
                'prohibited_items': 'Selling Prohibited Items',
                'other': 'Other'
            };

            const statusBadges = {
                'pending': '<span class="badge bg-warning">Pending</span>',
                'reviewed': '<span class="badge bg-info">Reviewed</span>',
                'resolved': '<span class="badge bg-success">Resolved</span>',
                'dismissed': '<span class="badge bg-secondary">Dismissed</span>'
            };

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${report.reportedUsername || 'Unknown'}<br><small class="text-muted">${report.reportedEmail || ''}</small></td>
                <td>${report.reporterUsername || 'Unknown'}<br><small class="text-muted">${report.reporterEmail || ''}</small></td>
                <td>${reasonLabels[report.reason] || report.reason}</td>
                <td>${report.customReason || '-'}</td>
                <td>${formatDate(report.createdAt instanceof Date ? report.createdAt : (report.createdAt ? new Date(report.createdAt) : null))}</td>
                <td>${statusBadges[report.status] || report.status}</td>
                <td>
                    ${report.status === 'pending' ? `
                        <button class="btn btn-sm btn-success me-1" onclick="updateReportStatus('${report.id}', 'resolved')">
                            <i class="fas fa-check"></i> Resolve
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="updateReportStatus('${report.id}', 'dismissed')">
                            <i class="fas fa-times"></i> Dismiss
                        </button>
                    ` : ''}
                    <button class="btn btn-sm btn-info" onclick="viewReportDetails('${report.id}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function updateReportStatus(reportId, status) {
        if (!confirm(`Are you sure you want to mark this report as ${status}?`)) return;

        try {
            // Use REST API to update report
            const updateData = {
                fields: {
                    status: { stringValue: status },
                    reviewedAt: { timestampValue: new Date().toISOString() },
                    reviewedBy: { stringValue: currentUser?.email || 'Admin' }
                }
            };

            const response = await fetch(`${FIREBASE_REST_BASE}/reports/${reportId}?key=${FIREBASE_CONFIG.apiKey}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            showSuccess(`Report marked as ${status}`);
            loadReports();
        } catch (error) {
            console.error('Error updating report status:', error);
            showError('Failed to update report status: ' + error.message);
        }
    }

    function viewReportDetails(reportId) {
        const report = reportsData[reportId];
        if (!report) return;

        const reasonLabels = {
            'inappropriate_content': 'Inappropriate Content',
            'spam_scam': 'Spam or Scam',
            'harassment': 'Harassment or Bullying',
            'fake_account': 'Fake Account',
            'prohibited_items': 'Selling Prohibited Items',
            'other': 'Other'
        };

        const modal = `
            <div class="modal fade" id="reportDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Report Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <table class="table">
                                <tr><th>Reported User:</th><td>${report.reportedUsername} (${report.reportedEmail})</td></tr>
                                <tr><th>Reporter:</th><td>${report.reporterUsername} (${report.reporterEmail})</td></tr>
                                <tr><th>Reason:</th><td>${reasonLabels[report.reason] || report.reason}</td></tr>
                                <tr><th>Details:</th><td>${report.customReason || 'N/A'}</td></tr>
                                <tr><th>Status:</th><td>${report.status}</td></tr>
                                <tr><th>Date:</th><td>${formatDate(report.createdAt instanceof Date ? report.createdAt : (report.createdAt ? new Date(report.createdAt) : null))}</td></tr>
                                ${report.reviewedAt ? `<tr><th>Reviewed At:</th><td>${formatDate(report.reviewedAt instanceof Date ? report.reviewedAt : (report.reviewedAt ? new Date(report.reviewedAt) : null))}</td></tr>` : ''}
                                ${report.reviewedBy ? `<tr><th>Reviewed By:</th><td>${report.reviewedBy}</td></tr>` : ''}
                                ${report.adminNotes ? `<tr><th>Admin Notes:</th><td>${report.adminNotes}</td></tr>` : ''}
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const modalDiv = document.createElement('div');
        modalDiv.innerHTML = modal;
        document.body.appendChild(modalDiv);
        const bsModal = new bootstrap.Modal(document.getElementById('reportDetailsModal'));
        bsModal.show();
        document.getElementById('reportDetailsModal').addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modalDiv);
        });
    }

    function updatePendingReportsBadge() {
        const pendingCount = Object.values(reportsData).filter(r => r.status === 'pending').length;
        const badge = document.getElementById('pendingReportsBadge');
        if (badge) {
            if (pendingCount > 0) {
                badge.textContent = pendingCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    // Admin Messaging Functions
    async function loadTotalUsersCount() {
        try {
            // Use REST API to get user count
            const response = await fetch(`${FIREBASE_REST_BASE}/users?key=${FIREBASE_CONFIG.apiKey}`);
            if (response.ok) {
                const data = await response.json();
                const count = data.documents ? data.documents.length : 0;
                const countElement = document.getElementById('totalUsersCount');
                if (countElement) {
                    countElement.textContent = count;
                }
            } else if (response.status === 404) {
                // Collection doesn't exist or is empty
                const countElement = document.getElementById('totalUsersCount');
                if (countElement) {
                    countElement.textContent = '0';
                }
            }
        } catch (error) {
            console.error('Error loading user count:', error);
            const countElement = document.getElementById('totalUsersCount');
            if (countElement) {
                countElement.textContent = '?';
            }
        }
    }

    async function sendAdminMessage(event) {
        event.preventDefault();
        
        const message = document.getElementById('adminMessage').value.trim();
        const messageType = document.getElementById('messageType').value;
        const sendBtn = document.getElementById('sendMessageBtn');

        if (!message) {
            showError('Please enter a message');
            return;
        }

        if (!confirm(`Are you sure you want to send this message to all users? This action cannot be undone.`)) {
            return;
        }

        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';

        try {
            // Get all users via REST API
            const usersResponse = await fetch(`${FIREBASE_REST_BASE}/users?key=${FIREBASE_CONFIG.apiKey}`);
            if (!usersResponse.ok) {
                throw new Error(`Failed to fetch users: ${usersResponse.status}`);
            }

            const usersData = await usersResponse.json();
            const users = usersData.documents || [];
            
            if (users.length === 0) {
                showError('No users found');
                return;
            }

            const title = messageType === 'warning' 
                ? '‚ö†Ô∏è Warning from Admin'
                : messageType === 'announcement'
                    ? 'üì¢ Announcement'
                    : '‚ÑπÔ∏è Important Notice';

            let totalSent = 0;
            const batchSize = 500; // Firestore REST API batch limit
            const currentTime = new Date().toISOString();

            // Send notifications in batches
            for (let i = 0; i < users.length; i += batchSize) {
                const batch = users.slice(i, i + batchSize);
                
                // Create notifications for this batch
                const batchPromises = batch.map(userDoc => {
                    const userId = userDoc.name.split('/').pop();
                    const notificationData = {
                        fields: {
                            userId: { stringValue: userId },
                            type: { stringValue: 'admin_message' },
                            title: { stringValue: title },
                            message: { stringValue: message },
                            messageType: { stringValue: messageType },
                            adminId: { stringValue: currentUser?.email || 'admin' },
                            adminName: { stringValue: currentUser?.name || 'Admin' },
                            read: { booleanValue: false },
                            createdAt: { timestampValue: currentTime }
                        }
                    };

                    return fetch(`${FIREBASE_REST_BASE}/notifications?key=${FIREBASE_CONFIG.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(notificationData)
                    });
                });

                await Promise.all(batchPromises);
                totalSent += batch.length;
                
                // Update progress
                sendBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Sending... (${totalSent}/${users.length})`;
            }

            showSuccess(`Message sent successfully to ${totalSent} users!`);
            document.getElementById('adminMessageForm').reset();
        } catch (error) {
            console.error('Error sending admin message:', error);
            showError('Failed to send message: ' + error.message);
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Send Message to All Users';
        }
    }

    // Load reports and user count when reports tab is shown
    document.getElementById('reports-tab')?.addEventListener('shown.bs.tab', function() {
        loadReports();
    });

    // Load user count when messaging tab is shown
    document.getElementById('messaging-tab')?.addEventListener('shown.bs.tab', function() {
        loadTotalUsersCount();
    });

</script>
<!-- EXIF.js library for reading EXIF data -->
<script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.js"></script>
</body>
</html>